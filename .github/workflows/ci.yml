name: CI Pipeline

# Workflow-level permissions (restrictive by default)
permissions:
  contents: read

on:
  push:
    branches:
      - main
      - 'feature/**'   # Alle feature/phase-* und andere feature-Branches
      - 'hotfix/**'
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Tests & Coverage
    runs-on: ubuntu-latest

    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libcairo2-dev \
          pkg-config \
          python3-dev

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create required directories
      run: mkdir -p logs

    - name: Run migrations
      env:
        DJANGO_SECRET_KEY: test-secret-key-for-ci-only
        DEBUG: 'True'
        ALLOWED_HOSTS: 'localhost,127.0.0.1'
      run: python manage.py migrate --noinput

    - name: Run tests with coverage
      env:
        DJANGO_SECRET_KEY: test-secret-key-for-ci-only
        DEBUG: 'True'
        ALLOWED_HOSTS: 'localhost,127.0.0.1'
      run: |
        pytest \
          --cov=core \
          --cov=ai_coach \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          -q

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        fail_ci_if_error: false
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    - name: Archive coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 14

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install black==25.1.0 isort==5.13.2 flake8==7.1.1 flake8-pyproject==1.2.3

    - name: Black formatting check
      run: black --check core/ config/ ai_coach/ --exclude migrations

    - name: isort import order check
      run: isort --check-only core/ config/ ai_coach/ --skip migrations

    - name: flake8 lint (hard fail)
      # Kein --exit-zero: Linter-Fehler brechen den Build ab
      run: flake8 core/ config/ ai_coach/ --count --statistics

  security:
    name: Security Checks
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit

    - name: Dependency vulnerability scan (safety scan)
      # continue-on-error: neue CVEs sollen CI nicht blocken, aber sichtbar sein
      run: safety scan --output screen
      continue-on-error: true

    - name: Static security analysis (bandit)
      # Medium+ Severity bricht ab; Low-Issues werden nur gemeldet
      run: |
        bandit -r core/ config/ ai_coach/ \
          -ll \
          -f json \
          -o bandit-report.json
      continue-on-error: false

    - name: Upload Bandit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json
        retention-days: 14
