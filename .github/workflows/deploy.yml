name: Deploy to Production

permissions:
  contents: read

on:
  # Auto-Deploy: nur wenn CI auf main vollständig grün ist
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main]
    types: [completed]

  # Manueller Trigger (z.B. für Hotfixes oder Re-Deploy)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment-Ziel'
        required: true
        default: 'production'
        type: choice
        options:
          - production

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    # Auto-Deploy: nur starten wenn CI erfolgreich war
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success')

    environment: production

    permissions:
      contents: read
      deployments: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          set -e  # Sofort abbrechen bei jedem Fehler

          cd ${{ secrets.PROJECT_PATH }}

          echo "=== [1/7] Git-Status prüfen ==="
          git fetch origin main

          # Aktuellen Commit für Rollback merken
          PREVIOUS_COMMIT=$(git rev-parse HEAD)
          echo "Rollback-Punkt: $PREVIOUS_COMMIT"

          # Python-Pfad: Plesk-Hosting nutzt 'venv/' (nicht '.venv/')
          PYTHON="venv/bin/python"
          PIP="venv/bin/pip"

          echo "=== [2/7] Datenbank-Backup ==="
          BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).json"
          $PYTHON manage.py dumpdata \
            --exclude auth.permission \
            --exclude contenttypes \
            --indent 2 \
            > "$BACKUP_FILE"
          echo "Backup gespeichert: $BACKUP_FILE"

          # Nur die letzten 5 Backups behalten, ältere löschen
          ls -t backup_*.json 2>/dev/null | tail -n +6 | xargs rm -f

          echo "=== [3/7] Code aktualisieren ==="
          git pull origin main

          echo "=== [4/7] Dependencies installieren ==="
          $PIP install -r requirements.txt --quiet

          echo "=== [5/7] Migrations + Static Files ==="
          $PYTHON manage.py migrate --noinput
          $PYTHON manage.py collectstatic --noinput --clear

          echo "=== [6/7] App-Server neu starten ==="
          sudo systemctl restart homegym

          echo "=== [7/7] Smoke Test ==="
          sleep 5  # Kurz warten bis App hochgefahren ist
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 10 \
            "https://gym.last-strawberry.com/accounts/login/")

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "❌ Smoke Test fehlgeschlagen! HTTP Status: $HTTP_STATUS"
            echo "=== ROLLBACK auf $PREVIOUS_COMMIT ==="
            git reset --hard "$PREVIOUS_COMMIT"
            $PIP install -r requirements.txt --quiet
            $PYTHON manage.py migrate --noinput
            sudo systemctl restart homegym
            echo "Rollback abgeschlossen."
            exit 1
          fi

          echo "✅ Deployment erfolgreich! HTTP Status: $HTTP_STATUS"

    - name: Deployment-Status melden
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ Deploy auf Production erfolgreich (Commit: ${{ github.sha }})"
        else
          echo "❌ Deploy fehlgeschlagen – Rollback wurde auf dem Server ausgeführt"
        fi
