{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans "Muskelgruppen" %} - HomeGym{% endblock %}

{% block extra_head %}
<style>
    [data-bs-theme="dark"] .svg-container {
        background: rgba(255,255,255,0.05); border-radius: 15px; padding: 2rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    [data-bs-theme="dark"] .exercise-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
    [data-bs-theme="dark"] .exercise-card:hover { background: rgba(255,255,255,0.1); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    [data-bs-theme="light"] .svg-container {
        background: rgba(255,255,255,0.8); border-radius: 15px; padding: 2rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid #dee2e6;
    }
    [data-bs-theme="light"] .exercise-card { background: #ffffff; border: 1px solid #dee2e6; }
    [data-bs-theme="light"] .exercise-card:hover { background: #f8f9fa; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .muscle-map-container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    #muscleSvg { width: 100%; height: auto; max-width: 1100px; display: block; margin: 0 auto; }
    #muscleSvg .muscle { cursor: pointer; transition: all 0.2s ease; }
    #muscleSvg .muscle:hover { fill: #0d6efd !important; stroke: #0d6efd !important; stroke-width: 4; }
    #muscleSvg .muscle.active { fill: #198754 !important; stroke: #198754 !important; stroke-width: 5; }
    .exercise-list { max-height: 600px; overflow-y: auto; }
    .exercise-card { transition: all 0.3s ease; }
    .exercise-card:hover { transform: translateY(-2px); }
</style>
{% endblock %}

{% block page_nav %}
<nav class="navbar navbar-page border-bottom mb-4">
  <div class="container-fluid">
    <a class="btn btn-outline-secondary border-0" href="{% url 'dashboard' %}">
        <i class="bi bi-arrow-left"></i> {% trans "Dashboard" %}
    </a>
    <span class="navbar-text page-title fw-bold">{% trans "Muskelgruppen" %}</span>
    <div style="width: 40px;">
        <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary border-0 ms-2" title="{% trans 'Theme wechseln' %}">
          <i class="bi bi-moon-fill" id="themeIcon"></i>
        </button>
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="muscle-map-container">
    <div class="text-center mb-4">
        <p class="lead text-muted opacity-75">{% trans "Klicke auf eine Muskelgruppe, um Übungen zu sehen" %}</p>
    </div>
    <div class="row g-4">
        <div class="col-lg-7">
            <div class="svg-container">
                <div id="svgWrapper"></div>
            </div>
        </div>
        <div class="col-lg-5">
            {% if selected_group %}
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-secondary">
                    <h4 class="mb-0">{{ group_label }}</h4>
                    <small class="text-light opacity-75">{{ uebungen.count }} {% trans "Übung(en)" %}</small>
                </div>
                <div class="card-body exercise-list">
                    {% for uebung in uebungen %}
                    <div class="exercise-card card mb-3">
                        <div class="card-body">
                            <h5 class="card-title mb-2">
                                <a href="{% url 'uebung_detail' uebung.id %}" class="text-decoration-none text-white">
                                    {{ uebung.bezeichnung }}
                                </a>
                            </h5>
                            <div class="d-flex gap-2 flex-wrap mb-2">
                                <span class="badge bg-primary">{{ uebung.get_bewegungstyp_display }}</span>
                                <span class="badge bg-info">{{ uebung.get_gewichts_typ_display }}</span>
                            </div>
                            <p class="card-text small text-light opacity-75 mb-0">
                                {{ uebung.beschreibung|truncatewords:20 }}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="card bg-dark border-secondary text-center">
                <div class="card-body py-5">
                    <i class="bi bi-hand-index fs-1 text-primary mb-3"></i>
                    <h5 class="mb-2">{% trans "Wähle eine Muskelgruppe" %}</h5>
                    <p class="text-muted mb-0">
                        {% trans "Klicke auf eine Muskelgruppe in der Grafik, um die verfügbaren Übungen zu sehen." %}
                    </p>
                </div>
            </div>
            {% endif %}

            <div class="card bg-dark border-secondary mt-3">
                <div class="card-header bg-secondary">
                    <h6 class="mb-0">{% trans "Schnellauswahl" %}</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        {% for code, label in muskelgruppen %}
                        <a href="?muskelgruppe={{ code }}" class="btn btn-sm btn-outline-primary">{{ label }}</a>
                        {% endfor %}
                    </div>
                    <a href="{% url 'uebungen_auswahl' %}" class="btn btn-primary w-100">
                        <i class="bi bi-list-ul"></i> {% trans "Alle Übungen anzeigen" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const muscleMapping = {{ muscle_mapping|safe }};
    const selectedGroup = "{{ selected_group }}";

    fetch("{% static 'core/images/muscle_map.svg' %}")
        .then(response => response.text())
        .then(svgContent => {
            document.getElementById('svgWrapper').innerHTML = svgContent;
            const svg = document.getElementById('svgWrapper').querySelector('svg');
            svg.id = 'muscleSvg';
            initializeMuscleMap();
        });

    function initializeMuscleMap() {
        Object.keys(muscleMapping).forEach(group => {
            const svgIds = muscleMapping[group];
            svgIds.forEach(svgId => {
                const element = document.getElementById(svgId);
                if (element) {
                    element.addEventListener('mouseenter', () => {
                        svgIds.forEach(id => { const el = document.getElementById(id); if (el) el.style.fill = '#0d6efd'; });
                    });
                    element.addEventListener('mouseleave', () => {
                        if (group !== selectedGroup) {
                            svgIds.forEach(id => { const el = document.getElementById(id); if (el) el.style.fill = '#d9d9d9'; });
                        }
                    });
                    element.addEventListener('click', () => { window.location.href = `?muskelgruppe=${group}`; });
                }
            });
        });
        if (selectedGroup && muscleMapping[selectedGroup]) {
            muscleMapping[selectedGroup].forEach(svgId => {
                const element = document.getElementById(svgId);
                if (element) { element.style.fill = '#198754'; element.classList.add('active'); }
            });
        }
    }
</script>
{% endblock %}
