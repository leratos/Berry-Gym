{% load static %}
{% load static %}
<!doctype html>
<html lang="de" data-bs-theme="dark" id="htmlRoot">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Körperwerte Verlauf</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'core/css/theme-styles.css' %}">
    
    <!-- Offline Manager CSS -->
    <link rel="stylesheet" href="{% static 'core/css/offline-manager.css' %}">
    
    <script src="{% static 'core/js/theme-toggle.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>

    <nav class="navbar navbar-page border-bottom mb-4">
      <div class="container-fluid">
        <a class="btn btn-outline-secondary border-0" href="{% url 'dashboard' %}">
            <i class="bi bi-arrow-left"></i> Dashboard
        </a>
        <span class="navbar-text page-title fw-bold">Körperwerte</span>
        <div>
            <a class="btn btn-outline-info border-0 me-2" href="{% url 'progress_photos' %}" title="Fortschrittsfotos">
                <i class="bi bi-camera"></i>
            </a>
            <a class="btn btn-primary border-0" href="{% url 'add_koerperwert' %}">
                <i class="bi bi-plus-lg"></i>
            </a>
                    <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary border-0 ms-2" title="Theme wechseln">
              <i class="bi bi-moon-fill" id="themeIcon"></i>
            </button>
</div>
      </div>
    </nav>

    <div class="container pb-5">

        {% if no_data %}
            <div class="text-center py-5 text-muted">
                <i class="bi bi-graph-up display-1 opacity-25"></i>
                <p class="mt-3">Noch keine Körperwerte erfasst.</p>
                <a href="{% url 'add_koerperwert' %}" class="btn btn-primary mt-2">Jetzt eintragen</a>
            </div>
        {% else %}

            <!-- Aktuelle Werte -->
            <div class="row g-3 mb-4">
                <div class="col-6">
                    <div class="card card-stat border-secondary text-center p-3">
                        <small class="text-secondary text-uppercase" style="font-size: 0.7rem;">Aktuell</small>
                        <div class="display-5 fw-bold text-white">{{ aktuelles_gewicht }}</div>
                        <small class="text-muted">kg</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card card-stat border-secondary text-center p-3">
                        <small class="text-secondary text-uppercase" style="font-size: 0.7rem;">Veränderung</small>
                        <div class="display-5 fw-bold {% if aenderung >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ aenderung|stringformat:"+.1f" }}
                        </div>
                        <small class="text-muted">kg</small>
                    </div>
                </div>
            </div>

            <!-- Gewichtsverlauf -->
            <div class="card card-stat border-secondary mb-4">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-3">
                        <i class="bi bi-graph-up me-2"></i>Gewichtsverlauf
                    </h6>
                    <canvas id="gewichtChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- BMI & FFMI Verlauf -->
            <div class="card card-stat border-secondary mb-4">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-3">
                        <i class="bi bi-speedometer2 me-2"></i>BMI & FFMI Verlauf
                    </h6>
                    <canvas id="bmiChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Körperfett Verlauf -->
            <div class="card card-stat border-secondary mb-4">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-3">
                        <i class="bi bi-percent me-2"></i>Körperfettanteil
                    </h6>
                    <canvas id="kfaChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Muskelmasse Verlauf -->
            <div class="card card-stat border-secondary mb-4">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-3">
                        <i class="bi bi-heart-pulse me-2"></i>Muskelmasse
                    </h6>
                    <canvas id="muskelChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Rohdaten Tabelle -->
            <div class="card card-stat border-secondary">
                <div class="card-header border-secondary">
                    <h6 class="mb-0 text-white">Alle Messungen</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead class="text-secondary small">
                            <tr>
                                <th>Datum</th>
                                <th>Gewicht</th>
                                <th>BMI</th>
                                <th>FFMI</th>
                                <th>KFA</th>
                                <th class="text-end">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for wert in werte reversed %}
                            <tr>
                                <td>{{ wert.datum|date:"d.m.Y" }}</td>
                                <td class="fw-bold">{{ wert.gewicht }} kg</td>
                                <td>{{ wert.bmi|default:"--" }}</td>
                                <td>{{ wert.ffmi|default:"--" }}</td>
                                <td>{{ wert.koerperfett_prozent|default:"--" }}{% if wert.koerperfett_prozent %}%{% endif %}</td>
                                <td class="text-end">
                                    <a href="{% url 'edit_koerperwert' wert.id %}" class="btn btn-sm btn-outline-primary border-0" title="Bearbeiten">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger border-0" onclick="confirmDelete({{ wert.id }})" title="Löschen">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% endif %}

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    {% if not no_data %}
    <script>
        const chartDefaults = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: true, labels: { color: '#adb5bd' } }
            },
            scales: {
                x: { ticks: { color: '#adb5bd' }, grid: { color: '#404448' } },
                y: { ticks: { color: '#adb5bd' }, grid: { color: '#404448' } }
            }
        };

        // Gewichtsverlauf
        new Chart(document.getElementById('gewichtChart'), {
            type: 'line',
            data: {
                labels: {{ labels_json|safe }},
                datasets: [{
                    label: 'Gewicht (kg)',
                    data: {{ gewicht_json|safe }},
                    borderColor: '#0dcaf0',
                    backgroundColor: 'rgba(13, 202, 240, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: chartDefaults
        });

        // BMI & FFMI
        new Chart(document.getElementById('bmiChart'), {
            type: 'line',
            data: {
                labels: {{ labels_json|safe }},
                datasets: [{
                    label: 'BMI',
                    data: {{ bmi_json|safe }},
                    borderColor: '#ffc107',
                    tension: 0.3
                }, {
                    label: 'FFMI',
                    data: {{ ffmi_json|safe }},
                    borderColor: '#198754',
                    tension: 0.3
                }]
            },
            options: chartDefaults
        });

        // Körperfett
        new Chart(document.getElementById('kfaChart'), {
            type: 'line',
            data: {
                labels: {{ labels_json|safe }},
                datasets: [{
                    label: 'Körperfett (%)',
                    data: {{ kfa_json|safe }},
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: chartDefaults
        });

        // Muskelmasse
        new Chart(document.getElementById('muskelChart'), {
            type: 'line',
            data: {
                labels: {{ labels_json|safe }},
                datasets: [{
                    label: 'Muskelmasse (kg)',
                    data: {{ muskel_json|safe }},
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: chartDefaults
        });
    </script>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Körperwert löschen</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Möchtest du diesen Körperwert wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <a href="#" id="confirmDeleteBtn" class="btn btn-danger">Löschen</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        function confirmDelete(wertId) {
            const deleteUrl = "{% url 'delete_koerperwert' 0 %}".replace('0', wertId);
            document.getElementById('confirmDeleteBtn').href = deleteUrl;
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }
    </script>
    
    <!-- Offline Manager -->
    <script src="{% static 'core/js/offline-manager.js' %}"></script>
    <script>
        // Offline Manager initialisieren
        const offlineManager = new OfflineManager();
    </script>
    {% endif %}
    
    <!-- Footer -->
    {% include 'core/includes/global_footer.html' %}
  </body>
</html>
