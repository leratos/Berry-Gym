{% load static %}
<!doctype html>
<html lang="de" data-bs-theme="dark" id="htmlRoot">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ausrüstung verwalten - HomeGym</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'core/css/theme-styles.css' %}">
    <link rel="stylesheet" href="{% static 'core/css/toast.css' %}">
    <script src="{% static 'core/js/theme-toggle.js' %}"></script>

    <style>
        .equipment-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .equipment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .equipment-card.selected {
            border-color: var(--bs-success);
            background: rgba(25, 135, 84, 0.1);
        }
        .equipment-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .category-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bs-body-bg);
            padding: 1rem 0;
            margin-bottom: 1rem;
        }
        .stats-card {
            transition: all 0.2s;
        }
        .stats-card:hover {
            transform: scale(1.02);
        }
        .search-box {
            position: sticky;
            top: 60px;
            z-index: 9;
            background: var(--bs-body-bg);
            padding: 1rem 0;
        }
    </style>
</head>
<body>
    {% include 'core/includes/global_header.html' %}

    <nav class="navbar navbar-page border-bottom">
        <div class="container-fluid">
            <a class="btn btn-outline-secondary border-0" href="{% url 'dashboard' %}">
                <i class="bi bi-arrow-left"></i> Dashboard
            </a>
            <span class="navbar-text">Equipment Manager</span>
            <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary border-0" title="Theme wechseln">
                <i class="bi bi-moon-fill" id="themeIcon"></i>
            </button>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Header & Info -->
        <div class="row mb-4">
            <div class="col">
                <h2 class="mb-3">
                    <i class="bi bi-tools me-2"></i>Meine Ausrüstung
                </h2>
                <div class="alert alert-info border-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Wähle deine verfügbare Ausrüstung aus.</strong>
                    Übungen werden automatisch gefiltert und der AI Coach berücksichtigt nur verfügbares Equipment.
                </div>
            </div>
        </div>

        <!-- Statistik -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card stats-card bg-success bg-opacity-10 border-success text-center">
                    <div class="card-body">
                        <i class="bi bi-check-circle-fill text-success fs-2 mb-2"></i>
                        <h3 class="text-success mb-0">{{ available_uebungen }}</h3>
                        <small class="text-muted">Verfügbare Übungen</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card bg-warning bg-opacity-10 border-warning text-center">
                    <div class="card-body">
                        <i class="bi bi-lock-fill text-warning fs-2 mb-2"></i>
                        <h3 class="text-warning mb-0">{{ unavailable_uebungen }}</h3>
                        <small class="text-muted">Gesperrte Übungen</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stats-card bg-primary bg-opacity-10 border-primary text-center">
                    <div class="card-body">
                        <i class="bi bi-collection-fill text-primary fs-2 mb-2"></i>
                        <h3 class="text-primary mb-0">{{ total_uebungen }}</h3>
                        <small class="text-muted">Gesamt Übungen</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schnell-Auswahl Presets -->
        <div class="card border-primary mb-4">
            <div class="card-header bg-primary bg-opacity-10 border-primary">
                <h5 class="mb-0">
                    <i class="bi bi-lightning-fill text-primary me-2"></i>Schnell-Auswahl
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="selectPreset('home-basic')">
                        <i class="bi bi-house me-1"></i>Home Gym Basic
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="selectPreset('home-advanced')">
                        <i class="bi bi-house-fill me-1"></i>Home Gym Advanced
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="selectPreset('fitness-studio')">
                        <i class="bi bi-building me-1"></i>Fitnessstudio
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="selectPreset('bodyweight')">
                        <i class="bi bi-person-arms-up me-1"></i>Nur Körpergewicht
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="selectPreset('none')">
                        <i class="bi bi-x-circle me-1"></i>Alles abwählen
                    </button>
                </div>
            </div>
        </div>

        <!-- Such-/Filterleiste -->
        <div class="search-box">
            <div class="row g-2 mb-3">
                <div class="col-md-8">
                    <input type="text"
                           id="equipmentSearch"
                           class="form-control"
                           placeholder="Equipment suchen...">
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="categoryFilter">
                        <option value="">Alle Kategorien</option>
                        {% for category in categorized_equipment.keys %}
                        <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Equipment nach Kategorien -->
        {% for category, config in categorized_equipment.items %}
        <div class="category-section mb-5" data-category="{{ category }}">
            <div class="category-header">
                <h4 class="text-{{ config.color }} border-bottom border-{{ config.color }} pb-2">
                    <i class="bi {{ config.icon }} me-2"></i>{{ category }}
                    <span class="badge bg-{{ config.color }} ms-2">{{ config.items|length }}</span>
                </h4>
            </div>

            <div class="row g-3">
                {% for equipment in config.items %}
                <div class="col-lg-3 col-md-4 col-sm-6 equipment-item"
                     data-name="{{ equipment|lower }}"
                     data-category="{{ category }}">
                    <div class="card equipment-card h-100 {% if equipment.id in user_equipment_ids %}selected{% endif %}"
                         onclick="toggleEquipmentCard({{ equipment.id }}, this)">
                        <div class="card-body text-center">
                            <div class="form-check form-switch position-absolute top-0 end-0 m-2">
                                <input
                                    class="form-check-input equipment-toggle"
                                    type="checkbox"
                                    id="equipment_{{ equipment.id }}"
                                    data-equipment-id="{{ equipment.id }}"
                                    {% if equipment.id in user_equipment_ids %}checked{% endif %}
                                    onclick="event.stopPropagation();"
                                >
                            </div>
                            <div class="equipment-icon text-{{ config.color }}">
                                <i class="bi {{ config.icon }}"></i>
                            </div>
                            <h6 class="card-title mb-2">{{ equipment }}</h6>
                            {% if equipment.beschreibung %}
                            <p class="card-text small text-muted mb-0">{{ equipment.beschreibung }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <!-- Keine Ergebnisse -->
        <div id="noResults" class="alert alert-warning d-none">
            <i class="bi bi-search me-2"></i>
            Keine Equipment-Typen gefunden. Versuche einen anderen Suchbegriff.
        </div>
    </div>

    <!-- Footer -->
    {% include 'core/includes/global_footer.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'core/js/loading-manager.js' %}"></script>
    <script src="{% static 'core/js/toast.js' %}"></script>

    <script>
        // Equipment Toggle via Card Click
        function toggleEquipmentCard(equipmentId, card) {
            const checkbox = card.querySelector(`#equipment_${equipmentId}`);
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
        }

        // Equipment Toggle via AJAX
        document.querySelectorAll('.equipment-toggle').forEach(checkbox => {
            checkbox.addEventListener('change', function(e) {
                const equipmentId = this.dataset.equipmentId;
                const isChecked = this.checked;
                const card = this.closest('.equipment-card');

                // Optimistic UI
                if (isChecked) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }

                // Disable während Request
                this.disabled = true;

                fetch(`/equipment/toggle/${equipmentId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    toast.success(`${data.equipment_name}: ${data.status === 'added' ? 'hinzugefügt' : 'entfernt'}`);

                    // Statistik aktualisieren (Seite neu laden nach kurzer Verzögerung)
                    setTimeout(() => location.reload(), 800);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Rollback bei Fehler
                    this.checked = !isChecked;
                    if (isChecked) {
                        card.classList.remove('selected');
                    } else {
                        card.classList.add('selected');
                    }
                    toast.error('Fehler beim Aktualisieren des Equipments');
                })
                .finally(() => {
                    this.disabled = false;
                });
            });
        });

        // Suche & Filter
        const searchInput = document.getElementById('equipmentSearch');
        const categoryFilter = document.getElementById('categoryFilter');

        function filterEquipment() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            let visibleCount = 0;

            document.querySelectorAll('.equipment-item').forEach(item => {
                const name = item.dataset.name;
                const category = item.dataset.category;

                const matchesSearch = name.includes(searchTerm);
                const matchesCategory = !selectedCategory || category === selectedCategory;

                if (matchesSearch && matchesCategory) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Kategorie-Sections verstecken wenn leer
            document.querySelectorAll('.category-section').forEach(section => {
                const visibleItems = section.querySelectorAll('.equipment-item[style="display: block;"], .equipment-item:not([style])').length;
                section.style.display = visibleItems > 0 ? 'block' : 'none';
            });

            // "Keine Ergebnisse" anzeigen
            document.getElementById('noResults').classList.toggle('d-none', visibleCount > 0);
        }

        searchInput.addEventListener('input', filterEquipment);
        categoryFilter.addEventListener('change', filterEquipment);

        // Preset Selection
        const presets = {
            'home-basic': ['KURZHANTEL', 'BANK', 'KLIMMZUG', 'MATTE', 'KOERPER'],
            'home-advanced': ['LANGHANTEL', 'KURZHANTEL', 'BANK', 'SCHRAEGBANK', 'KLIMMZUG', 'DIP', 'MATTE', 'KOERPER', 'WIDERSTANDSBAND'],
            'fitness-studio': ['LANGHANTEL', 'KURZHANTEL', 'KETTLEBELL', 'BANK', 'SCHRAEGBANK', 'KLIMMZUG', 'DIP', 'KABELZUG', 'BEINPRESSE', 'LEG_CURL', 'LEG_EXT', 'SMITHMASCHINE', 'HACKENSCHMIDT', 'RUDERMASCHINE', 'ADDUKTOREN_MASCHINE', 'ABDUKTOREN_MASCHINE', 'MATTE', 'KOERPER'],
            'bodyweight': ['MATTE', 'KOERPER', 'KLIMMZUG', 'DIP'],
            'none': []
        };

        function selectPreset(presetName) {
            const selectedEquipment = presets[presetName] || [];
            let changedCount = 0;

            document.querySelectorAll('.equipment-toggle').forEach(checkbox => {
                const equipmentName = checkbox.closest('.equipment-item').dataset.name.toUpperCase();
                const shouldBeChecked = selectedEquipment.some(eq =>
                    equipmentName.includes(eq) || eq.includes(equipmentName)
                );

                if (checkbox.checked !== shouldBeChecked) {
                    checkbox.checked = shouldBeChecked;
                    checkbox.dispatchEvent(new Event('change'));
                    changedCount++;
                }
            });

            if (changedCount === 0) {
                toast.info('Preset bereits aktiv');
            }
        }
    </script>
</body>
</html>
