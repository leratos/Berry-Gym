{% extends 'base.html' %}
{% load static %}

{% block title %}Ausrüstung verwalten - HomeGym{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'core/css/toast.css' %}">
<style>
    .equipment-card { transition: all 0.3s ease; border: 2px solid transparent; }
    .equipment-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .equipment-card.selected { border-color: var(--bs-success); background: rgba(25,135,84,0.1); }
    .equipment-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .category-header { position: sticky; top: 0; z-index: 10; background: var(--bs-body-bg); padding: 1rem 0; margin-bottom: 1rem; }
    .stats-card { transition: all 0.2s; }
    .stats-card:hover { transform: scale(1.02); }
    .search-box { position: sticky; top: 60px; z-index: 9; background: var(--bs-body-bg); padding: 1rem 0; }
</style>
{% endblock %}

{% block page_nav %}
<nav class="navbar navbar-page border-bottom">
    <div class="container-fluid">
        <a class="btn btn-outline-secondary border-0" href="{% url 'dashboard' %}">
            <i class="bi bi-arrow-left"></i> Dashboard
        </a>
        <span class="navbar-text">Equipment Manager</span>
        <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary border-0" title="Theme wechseln">
            <i class="bi bi-moon-fill" id="themeIcon"></i>
        </button>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h2 class="mb-3"><i class="bi bi-tools me-2"></i>Meine Ausrüstung</h2>
            <div class="alert alert-info border-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Wähle deine verfügbare Ausrüstung aus.</strong>
                Übungen werden automatisch gefiltert und der AI Coach berücksichtigt nur verfügbares Equipment.
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card stats-card bg-success bg-opacity-10 border-success text-center">
                <div class="card-body">
                    <i class="bi bi-check-circle-fill text-success fs-2 mb-2"></i>
                    <h3 class="text-success mb-0">{{ available_uebungen }}</h3>
                    <small class="text-muted">Verfügbare Übungen</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card bg-warning bg-opacity-10 border-warning text-center">
                <div class="card-body">
                    <i class="bi bi-lock-fill text-warning fs-2 mb-2"></i>
                    <h3 class="text-warning mb-0">{{ unavailable_uebungen }}</h3>
                    <small class="text-muted">Gesperrte Übungen</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card bg-primary bg-opacity-10 border-primary text-center">
                <div class="card-body">
                    <i class="bi bi-collection-fill text-primary fs-2 mb-2"></i>
                    <h3 class="text-primary mb-0">{{ total_uebungen }}</h3>
                    <small class="text-muted">Gesamt Übungen</small>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-primary mb-4">
        <div class="card-header bg-primary bg-opacity-10 border-primary">
            <h5 class="mb-0"><i class="bi bi-lightning-fill text-primary me-2"></i>Schnell-Auswahl</h5>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-outline-primary" onclick="selectPreset('home-basic')">
                    <i class="bi bi-house me-1"></i>Home Gym Basic
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="selectPreset('home-advanced')">
                    <i class="bi bi-house-fill me-1"></i>Home Gym Advanced
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="selectPreset('fitness-studio')">
                    <i class="bi bi-building me-1"></i>Fitnessstudio
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="selectPreset('bodyweight')">
                    <i class="bi bi-person-arms-up me-1"></i>Nur Körpergewicht
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="selectPreset('none')">
                    <i class="bi bi-x-circle me-1"></i>Alles abwählen
                </button>
            </div>
        </div>
    </div>

    <div class="search-box">
        <div class="row g-2 mb-3">
            <div class="col-md-8">
                <input type="text" id="equipmentSearch" class="form-control" placeholder="Equipment suchen...">
            </div>
            <div class="col-md-4">
                <select class="form-select" id="categoryFilter">
                    <option value="">Alle Kategorien</option>
                    {% for category in categorized_equipment.keys %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    {% for category, config in categorized_equipment.items %}
    <div class="category-section mb-5" data-category="{{ category }}">
        <div class="category-header">
            <h4 class="text-{{ config.color }} border-bottom border-{{ config.color }} pb-2">
                <i class="bi {{ config.icon }} me-2"></i>{{ category }}
                <span class="badge bg-{{ config.color }} ms-2">{{ config.items|length }}</span>
            </h4>
        </div>
        <div class="row g-3">
            {% for equipment in config.items %}
            <div class="col-lg-3 col-md-4 col-sm-6 equipment-item"
                 data-name="{{ equipment|lower }}"
                 data-category="{{ category }}">
                <div class="card equipment-card h-100 {% if equipment.id in user_equipment_ids %}selected{% endif %}"
                     onclick="toggleEquipmentCard({{ equipment.id }}, this)">
                    <div class="card-body text-center">
                        <div class="form-check form-switch position-absolute top-0 end-0 m-2">
                            <input class="form-check-input equipment-toggle"
                                   type="checkbox"
                                   id="equipment_{{ equipment.id }}"
                                   data-equipment-id="{{ equipment.id }}"
                                   {% if equipment.id in user_equipment_ids %}checked{% endif %}
                                   onclick="event.stopPropagation();">
                        </div>
                        <div class="equipment-icon text-{{ config.color }}">
                            <i class="bi {{ config.icon }}"></i>
                        </div>
                        <h6 class="card-title mb-2">{{ equipment }}</h6>
                        {% if equipment.beschreibung %}
                        <p class="card-text small text-muted mb-0">{{ equipment.beschreibung }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <div id="noResults" class="alert alert-warning d-none">
        <i class="bi bi-search me-2"></i>
        Keine Equipment-Typen gefunden. Versuche einen anderen Suchbegriff.
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'core/js/loading-manager.js' %}"></script>
<script src="{% static 'core/js/toast.js' %}"></script>
<script>
    function toggleEquipmentCard(equipmentId, card) {
        const checkbox = card.querySelector(`#equipment_${equipmentId}`);
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change'));
    }

    document.querySelectorAll('.equipment-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const equipmentId = this.dataset.equipmentId;
            const isChecked = this.checked;
            const card = this.closest('.equipment-card');
            card.classList.toggle('selected', isChecked);
            this.disabled = true;
            fetch(`/equipment/toggle/${equipmentId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}', 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(r => r.json())
            .then(data => {
                toast.success(`${data.equipment_name}: ${data.status === 'added' ? 'hinzugefügt' : 'entfernt'}`);
                setTimeout(() => location.reload(), 800);
            })
            .catch(() => {
                this.checked = !isChecked;
                card.classList.toggle('selected', !isChecked);
                toast.error('Fehler beim Aktualisieren des Equipments');
            })
            .finally(() => { this.disabled = false; });
        });
    });

    const searchInput = document.getElementById('equipmentSearch');
    const categoryFilter = document.getElementById('categoryFilter');

    function filterEquipment() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedCategory = categoryFilter.value;
        let visibleCount = 0;
        document.querySelectorAll('.equipment-item').forEach(item => {
            const matches = item.dataset.name.includes(searchTerm) &&
                            (!selectedCategory || item.dataset.category === selectedCategory);
            item.style.display = matches ? 'block' : 'none';
            if (matches) visibleCount++;
        });
        document.querySelectorAll('.category-section').forEach(section => {
            const visible = section.querySelectorAll('.equipment-item:not([style*="none"])').length;
            section.style.display = visible > 0 ? 'block' : 'none';
        });
        document.getElementById('noResults').classList.toggle('d-none', visibleCount > 0);
    }

    searchInput.addEventListener('input', filterEquipment);
    categoryFilter.addEventListener('change', filterEquipment);

    const presets = {
        'home-basic': ['KURZHANTEL','BANK','KLIMMZUG','MATTE','KOERPER'],
        'home-advanced': ['LANGHANTEL','KURZHANTEL','BANK','SCHRAEGBANK','KLIMMZUG','DIP','MATTE','KOERPER','WIDERSTANDSBAND'],
        'fitness-studio': ['LANGHANTEL','KURZHANTEL','KETTLEBELL','BANK','SCHRAEGBANK','KLIMMZUG','DIP','KABELZUG','BEINPRESSE','LEG_CURL','LEG_EXT','SMITHMASCHINE','HACKENSCHMIDT','RUDERMASCHINE','ADDUKTOREN_MASCHINE','ABDUKTOREN_MASCHINE','MATTE','KOERPER'],
        'bodyweight': ['MATTE','KOERPER','KLIMMZUG','DIP'],
        'none': []
    };

    function selectPreset(presetName) {
        const selected = presets[presetName] || [];
        let changed = 0;
        document.querySelectorAll('.equipment-toggle').forEach(checkbox => {
            const name = checkbox.closest('.equipment-item').dataset.name.toUpperCase();
            const should = selected.some(eq => name.includes(eq) || eq.includes(name));
            if (checkbox.checked !== should) { checkbox.checked = should; checkbox.dispatchEvent(new Event('change')); changed++; }
        });
        if (changed === 0) toast.info('Preset bereits aktiv');
    }
</script>
{% endblock %}
