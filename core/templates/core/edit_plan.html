{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{% trans "Plan bearbeiten" %} - {{ plan.name }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'core/css/toast.css' %}">
<style>
    .exercise-card { cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
    .exercise-card:hover { border-color: #0dcaf0; transform: translateY(-2px); }
    .exercise-card.selected { border-color: #198754; background-color: rgba(25,135,84,0.1); }
    .muscle-badge { font-size: 0.7rem; padding: 0.2rem 0.5rem; }
    .muscle-badge.primary { background-color: #198754; }
    .muscle-badge.secondary { background-color: #0dcaf0; }
    .selected-exercises { position: sticky; top: 20px; }
    .exercise-order { counter-reset: exercise-counter; }
    .exercise-order-item::before { counter-increment: exercise-counter; content: counter(exercise-counter) ". "; font-weight: bold; color: #198754; }
    .superset-badge { font-size: 0.65rem; padding: 0.15rem 0.4rem; font-weight: bold; }
    .superset-group-1 { border-left: 4px solid #ffc107 !important; }
    .superset-group-2 { border-left: 4px solid #0dcaf0 !important; }
    .superset-group-3 { border-left: 4px solid #d63384 !important; }
    .superset-group-4 { border-left: 4px solid #6610f2 !important; }
    .superset-group-5 { border-left: 4px solid #20c997 !important; }
</style>
{% endblock %}

{% block page_nav %}
<nav class="navbar navbar-page border-bottom">
    <div class="container-fluid">
        <a class="btn btn-outline-secondary border-0" href="{% url 'dashboard' %}">
            <i class="bi bi-arrow-left"></i> {% trans "Dashboard" %}
        </a>
        <span class="navbar-text">{% trans "Plan bearbeiten" %}</span>
        <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary border-0 ms-2">
            <i class="bi bi-moon-fill" id="themeIcon"></i>
        </button>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card card-stat border-secondary mb-4">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-list-check me-2"></i>{% trans "√úbungen ausw√§hlen" %}</h5>
                    <div class="mb-3">
                        <input type="text" id="searchExercises" class="form-control" placeholder="{% trans '√úbung suchen...' %}">
                    </div>
                    {% for gruppe, uebungen in uebungen_nach_gruppe.items %}
                    <div class="muscle-group-section mb-4">
                        <h6 class="text-secondary text-uppercase mb-3"><i class="bi bi-diagram-3 me-2"></i>{{ gruppe }}</h6>
                        <div class="row g-2">
                            {% for uebung in uebungen %}
                            <div class="col-md-6 exercise-item" data-name="{{ uebung.bezeichnung|lower }}">
                                <div class="card exercise-card bg-black border-secondary h-100 {% if uebung.in_plan %}selected{% endif %}"
                                     data-id="{{ uebung.id }}" data-name="{{ uebung.bezeichnung }}"
                                     data-muscle="{{ uebung.muskelgruppe_label }}" data-pattern="{{ uebung.bewegungstyp }}"
                                     data-reihenfolge="{{ uebung.reihenfolge|default:'9999' }}"
                                     data-saetze="{{ uebung.saetze|default:'3' }}" data-wdh="{{ uebung.wdh|default:'8-12' }}"
                                     data-pausenzeit="{{ uebung.pausenzeit|default:'120' }}"
                                     data-superset="{{ uebung.superset_gruppe|default:'0' }}"
                                     data-notiz="{{ uebung.plan_notiz|default:'' }}"
                                     onclick="toggleExercise(this)">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <strong>{{ uebung.bezeichnung }}</strong>
                                                <div class="mt-1">
                                                    <span class="badge muscle-badge primary me-1"><i class="bi bi-star-fill"></i> {{ uebung.muskelgruppe_label }}</span>
                                                    {% for hilfs in uebung.hilfsmuskeln %}
                                                    <span class="badge muscle-badge secondary me-1"><i class="bi bi-plus-circle"></i> {{ hilfs }}</span>
                                                    {% endfor %}
                                                </div>
                                                <small class="text-muted d-block mt-1"><i class="bi bi-info-circle"></i> {{ uebung.gewichts_typ }}</small>
                                            </div>
                                            <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem; {% if not uebung.in_plan %}display: none;{% endif %}"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="selected-exercises">
                <div class="card card-stat border-warning mb-3" id="performanceWarningsCard" style="display: none;">
                    <div class="card-body">
                        <h6 class="card-title text-warning"><i class="bi bi-exclamation-triangle me-2"></i>{% trans "Optimierungsvorschl√§ge" %}</h6>
                        <div id="performanceWarnings" class="small"></div>
                        <button type="button" class="btn btn-warning btn-sm w-100 mt-2" onclick="startOptimization()">
                            <i class="bi bi-stars me-2"></i>{% trans "KI-Optimierung starten" %}
                        </button>
                    </div>
                </div>

                <div class="card card-stat border-secondary mb-3">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-pencil-square me-2"></i>{% trans "Plan bearbeiten" %}</h5>
                        <form method="post" id="planForm">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label">{% trans "Name des Plans" %} *</label>
                                <input type="text" name="name" class="form-control" value="{{ plan.name }}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">{% trans "Beschreibung" %}</label>
                                <textarea name="beschreibung" class="form-control" rows="2">{{ plan.beschreibung }}</textarea>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="is_public" id="isPublicCheck" {% if plan.is_public %}checked{% endif %}>
                                    <label class="form-check-label" for="isPublicCheck">
                                        <i class="bi bi-globe me-1"></i> {% trans "Plan √∂ffentlich machen" %}
                                        <small class="text-muted d-block">{% trans "Andere User k√∂nnen diesen Plan sehen und kopieren" %}</small>
                                    </label>
                                </div>
                            </div>
                            <hr class="border-secondary">
                            <h6 class="text-secondary mb-3">{% trans "Ausgew√§hlte √úbungen" %} (<span id="selectedCount">0</span>)</h6>
                            <div id="recommendationWarnings"></div>
                            <div id="selectedExercises" class="exercise-order"></div>
                            <button type="submit" class="btn btn-success w-100 mb-2" id="submitBtn">
                                <i class="bi bi-check-lg me-2"></i>{% trans "√Ñnderungen speichern" %}
                            </button>
                            <a href="{% url 'plan_details' plan.id %}" class="btn btn-secondary w-100">
                                <i class="bi bi-x-lg me-2"></i>{% trans "Abbrechen" %}
                            </a>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'core/plan_optimization_modal.html' %}
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'core/js/toast.js' %}"></script>
<script src="{% static 'core/js/loading-manager.js' %}"></script>
<script>
    let selectedExercises = [];

    document.addEventListener('DOMContentLoaded', function() {
        const planExercises = [];
        document.querySelectorAll('.exercise-card.selected').forEach(card => {
            planExercises.push({
                id: card.dataset.id, name: card.dataset.name, muscle: card.dataset.muscle,
                reihenfolge: parseInt(card.dataset.reihenfolge) || 9999,
                saetze: card.dataset.saetze || 3, wdh: card.dataset.wdh || '8-12',
                pausenzeit: parseInt(card.dataset.pausenzeit) || 120,
                supersetGroup: parseInt(card.dataset.superset) || 0,
                notiz: card.dataset.notiz || ''
            });
        });
        planExercises.sort((a, b) => a.reihenfolge - b.reihenfolge);
        selectedExercises = planExercises.map(ex => ({
            id: ex.id, name: ex.name, muscle: ex.muscle,
            saetze: ex.saetze, wdh: ex.wdh, pausenzeit: ex.pausenzeit,
            supersetGroup: ex.supersetGroup, notiz: ex.notiz || ''
        }));
        updateSelectedList();
        analyzeBalance();
        loadPerformanceWarnings();
    });

    function toggleExercise(card) {
        const id = card.dataset.id;
        const icon = card.querySelector('.bi-check-circle-fill');
        if (card.classList.contains('selected')) {
            card.classList.remove('selected'); icon.style.display = 'none';
            selectedExercises = selectedExercises.filter(e => e.id != id);
        } else {
            card.classList.add('selected'); icon.style.display = 'block';
            selectedExercises.push({ id, name: card.dataset.name, muscle: card.dataset.muscle, saetze: card.dataset.saetze || 3, wdh: card.dataset.wdh || '8-12', pausenzeit: parseInt(card.dataset.pausenzeit) || 120, supersetGroup: 0, notiz: '' });
        }
        updateSelectedList(); analyzeBalance();
    }

    function removeExercise(id) {
        selectedExercises = selectedExercises.filter(e => e.id != id);
        const card = document.querySelector(`.exercise-card[data-id="${id}"]`);
        if (card) { card.classList.remove('selected'); card.querySelector('.bi-check-circle-fill').style.display = 'none'; }
        updateSelectedList(); analyzeBalance();
    }

    function moveUp(id) {
        const idx = selectedExercises.findIndex(e => e.id == id);
        if (idx > 0) { [selectedExercises[idx-1], selectedExercises[idx]] = [selectedExercises[idx], selectedExercises[idx-1]]; updateSelectedList(); }
    }
    function moveDown(id) {
        const idx = selectedExercises.findIndex(e => e.id == id);
        if (idx < selectedExercises.length-1) { [selectedExercises[idx], selectedExercises[idx+1]] = [selectedExercises[idx+1], selectedExercises[idx]]; updateSelectedList(); }
    }
    function setSupersetGroup(id, group) {
        const ex = selectedExercises.find(e => e.id == id);
        if (ex) { ex.supersetGroup = group; updateSelectedList(); }
    }
    function updateExerciseData(id, field, value) {
        const ex = selectedExercises.find(e => e.id == id);
        if (ex) ex[field] = value;
    }

    function updateSelectedList() {
        const container = document.getElementById('selectedExercises');
        const count = document.getElementById('selectedCount');
        const submitBtn = document.getElementById('submitBtn');
        count.textContent = selectedExercises.length;
        submitBtn.disabled = selectedExercises.length === 0;
        if (selectedExercises.length === 0) {
            container.innerHTML = '<p class="text-muted small text-center py-3"><i class="bi bi-arrow-left-circle me-1"></i>W√§hle √úbungen aus</p>';
            return;
        }
        container.innerHTML = selectedExercises.map((ex, idx) => {
            const ssCls = ex.supersetGroup > 0 ? `superset-group-${ex.supersetGroup}` : '';
            const ssBadge = ex.supersetGroup > 0 ? `<span class="badge bg-warning text-dark superset-badge ms-1">S${ex.supersetGroup}</span>` : '';
            return `<div class="card bg-black border-secondary mb-2 ${ssCls}">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <div class="exercise-order-item"><strong>${ex.name}</strong>${ssBadge}<small class="text-muted d-block">${ex.muscle}</small></div>
                            <input type="hidden" name="uebungen" value="${ex.id}">
                            <input type="hidden" name="superset_gruppe_${ex.id}" value="${ex.supersetGroup}">
                            <div class="row g-2 mt-1">
                                <div class="col-6"><input type="number" name="saetze_${ex.id}" class="form-control form-control-sm" placeholder="S√§tze" value="${ex.saetze||3}" min="1" max="10" onchange="updateExerciseData(${ex.id},'saetze',this.value)"></div>
                                <div class="col-6"><input type="text" name="wdh_${ex.id}" class="form-control form-control-sm" placeholder="Wdh." value="${ex.wdh||'8-12'}" onchange="updateExerciseData(${ex.id},'wdh',this.value)"></div>
                                <div class="col-12 mt-1">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-dark text-muted border-secondary"><i class="bi bi-stopwatch"></i></span>
                                        <input type="number" name="pause_${ex.id}" class="form-control form-control-sm bg-dark text-white border-secondary"
                                            placeholder="Pause (s)" value="${ex.pausenzeit||120}" min="30" max="600" step="15"
                                            onchange="updateExerciseData(${ex.id},'pausenzeit',parseInt(this.value))">
                                        <span class="input-group-text bg-dark text-muted border-secondary">s</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2">
                                <label class="text-muted small">Superset:</label>
                                <div class="btn-group btn-group-sm w-100">
                                    <button type="button" class="btn ${ex.supersetGroup===0?'btn-secondary':'btn-outline-secondary'}" onclick="setSupersetGroup(${ex.id},0)">Keine</button>
                                    <button type="button" class="btn ${ex.supersetGroup===1?'btn-warning':'btn-outline-warning'}" onclick="setSupersetGroup(${ex.id},1)">S1</button>
                                    <button type="button" class="btn ${ex.supersetGroup===2?'btn-info':'btn-outline-info'}" onclick="setSupersetGroup(${ex.id},2)">S2</button>
                                    <button type="button" class="btn ${ex.supersetGroup===3?'btn-danger':'btn-outline-danger'}" onclick="setSupersetGroup(${ex.id},3)">S3</button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <input type="text" name="notiz_${ex.id}" class="form-control form-control-sm bg-dark text-white border-secondary"
                                    placeholder="üí° Technik-Hinweis (optional)" value="${ex.notiz||''}"
                                    onchange="updateExerciseData(${ex.id},'notiz',this.value)"
                                    maxlength="200">
                            </div>
                        </div>
                        <div class="btn-group-vertical ms-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveUp('${ex.id}')" ${idx===0?'disabled':''}>
                                <i class="bi bi-arrow-up"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveDown('${ex.id}')" ${idx===selectedExercises.length-1?'disabled':''}>
                                <i class="bi bi-arrow-down"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExercise('${ex.id}')">
                                <i class="bi bi-x-lg"></i></button>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function analyzeBalance() {
        const muscleGroups = {};
        selectedExercises.forEach(ex => {
            const card = document.querySelector(`.exercise-card[data-id="${ex.id}"]`);
            const muscle = card?.dataset.muscle; const pattern = card?.dataset.pattern;
            if (muscle) { if (!muscleGroups[muscle]) muscleGroups[muscle] = new Set(); muscleGroups[muscle].add(pattern); }
        });
        const container = document.getElementById('recommendationWarnings');
        container.innerHTML = ''; container.style.display = 'none';
    }

    document.getElementById('searchExercises').addEventListener('input', function(e) {
        const search = e.target.value.toLowerCase();
        document.querySelectorAll('.exercise-item').forEach(item => {
            item.style.display = item.dataset.name.includes(search) ? 'block' : 'none';
        });
    });

    function loadPerformanceWarnings() {
        const planId = {{ plan.id }};
        const card = document.getElementById('performanceWarningsCard');
        fetch(`/api/analyze-plan/?plan_id=${planId}&days=30`)
            .then(res => res.json())
            .then(data => {
                if (data.success && data.warnings?.length > 0) {
                    const top = data.warnings.sort((a,b) => a.severity==='warning'?-1:1).slice(0,3);
                    document.getElementById('performanceWarnings').innerHTML = '<ul class="mb-0 ps-3">' +
                        top.map(w => `<li class="mb-1"><i class="bi bi-${w.severity==='warning'?'exclamation-circle':'info-circle'} me-1"></i>${w.message}</li>`).join('') + '</ul>' +
                        (data.warnings.length > 3 ? `<p class="text-muted small mb-0 mt-2">+ ${data.warnings.length-3} weitere Hinweise</p>` : '');
                    card.style.display = 'block';
                }
            })
            .catch(err => console.error('Fehler:', err));
    }

    function startOptimization() {
        const planId = {{ plan.id }};
        const btn = event.target;
        const requestId = loadingManager.startButtonWithText(btn, 'KI analysiert...');
        fetch('/api/optimize-plan/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ plan_id: planId, days: 30 })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success && data.optimizations) {
                toast.success(`‚úì ${data.optimizations.length} Optimierungen gefunden`);
                showOptimizationModal(data.optimizations, data.cost, data.model);
            } else { toast.error(data.error || 'Optimierung fehlgeschlagen'); }
        })
        .catch(() => toast.error('Netzwerkfehler.'))
        .finally(() => loadingManager.stopButton(btn, requestId));
    }

    function showOptimizationModal(optimizations, cost, model) {
        currentOptimizations = optimizations;
        selectedOptimizations.clear();
        document.getElementById('optimizationModel').textContent = `Model: ${model}`;
        if (optimizations.length === 0) {
            document.getElementById('optimizationsList').style.display = 'none';
            document.getElementById('noOptimizations').style.display = 'block';
        } else {
            document.getElementById('optimizationsList').style.display = 'block';
            document.getElementById('noOptimizations').style.display = 'none';
            renderOptimizations(optimizations);
        }
        new bootstrap.Modal(document.getElementById('optimizationModal')).show();
    }
</script>
{% endblock %}
