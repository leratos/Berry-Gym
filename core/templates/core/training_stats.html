{% load static %}
<script src="{% static 'core/js/theme-toggle.js' %}"></script>
<!doctype html>
<html lang="de" data-bs-theme="dark" id="htmlRoot">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Trainingsstatistiken</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'core/css/theme-styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>

    <nav class="navbar navbar-dark bg-dark border-bottom border-secondary mb-4">
      <div class="container-fluid">
        <a class="btn btn-outline-secondary border-0" href="{% url 'dashboard' %}">
            <i class="bi bi-arrow-left"></i> Dashboard
        </a>
        <span class="navbar-text text-white fw-bold">Statistiken</span>
        <div>
            <a href="{% url 'export_training_pdf' %}" class="btn btn-outline-danger border-0 me-2" title="Als PDF exportieren">
                <i class="bi bi-file-pdf"></i> PDF
            </a>
            <a href="{% url 'export_training_csv' %}" class="btn btn-outline-success border-0" title="Als CSV exportieren">
                <i class="bi bi-file-earmark-spreadsheet"></i> CSV
            </a>
            <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary border-0" title="Theme wechseln">
              <i class="bi bi-moon-fill" id="themeIcon"></i>
            </button>
        </div>
      </div>
    </nav>

    <div class="container pb-5">

        {% if no_data %}
            <div class="text-center py-5 text-muted">
                <i class="bi bi-graph-up display-1 opacity-25"></i>
                <p class="mt-3">Noch keine Trainings-Daten vorhanden.</p>
                <a href="{% url 'training_select_plan' %}" class="btn btn-primary mt-2">Jetzt trainieren</a>
            </div>
        {% else %}

            <!-- Zusammenfassung -->
            <div class="row g-3 mb-4">
                <div class="col-4">
                    <div class="card card-stat border-secondary text-center p-3">
                        <small class="text-secondary text-uppercase" style="font-size: 0.7rem;">Trainings</small>
                        <div class="display-6 fw-bold text-primary">{{ trainings_count }}</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card card-stat border-secondary text-center p-3">
                        <small class="text-secondary text-uppercase" style="font-size: 0.7rem;">Gesamt-Volumen</small>
                        <div class="display-6 fw-bold text-success">{{ gesamt_volumen|floatformat:0 }}</div>
                        <small class="text-muted">kg</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card card-stat border-secondary text-center p-3">
                        <small class="text-secondary text-uppercase" style="font-size: 0.7rem;">Ø pro Training</small>
                        <div class="display-6 fw-bold text-info">{{ durchschnitt_volumen|floatformat:0 }}</div>
                        <small class="text-muted">kg</small>
                    </div>
                </div>
            </div>

            <!-- Volumen-Progression (pro Training) -->
            <div class="card card-stat border-secondary mb-4">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-3">
                        <i class="bi bi-graph-up-arrow me-2"></i>Volumen-Progression (pro Training)
                    </h6>
                    <canvas id="volumenChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Wöchentliches Volumen -->
            <div class="card card-stat border-secondary mb-4">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-3">
                        <i class="bi bi-calendar-week me-2"></i>Wöchentliches Volumen (letzte 12 Wochen)
                    </h6>
                    
                    <!-- Deload-Warnungen -->
                    {% if deload_warnings %}
                    <div class="alert alert-warning border-warning mb-3">
                        <h6 class="mb-2">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>Volumen-Analyse
                        </h6>
                        {% for warning in deload_warnings %}
                            {% if warning.type == 'spike' %}
                            <div class="small mb-2">
                                <strong>{{ warning.week }}:</strong> 
                                <span class="text-danger">+{{ warning.increase }}% Anstieg</span> 
                                ({{ warning.volume }} kg)
                                <br>
                                <i class="bi bi-info-circle me-1"></i>
                                <em>Achte auf ausreichende Regeneration! Bei zu schnellem Volumen-Anstieg steigt das Verletzungsrisiko.</em>
                            </div>
                            {% elif warning.type == 'drop' %}
                            <div class="small mb-2">
                                <strong>{{ warning.week }}:</strong> 
                                <span class="text-info">-{{ warning.decrease }}% Rückgang</span> 
                                ({{ warning.volume }} kg)
                                <br>
                                <i class="bi bi-info-circle me-1"></i>
                                <em>Starker Volumen-Rückgang erkannt. Achte auf Motivation und Regeneration.</em>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <canvas id="weeklyChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Muskelgruppen-Balance -->
            <div class="card card-stat border-secondary mb-4">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-3">
                        <i class="bi bi-diagram-3 me-2"></i>Muskelgruppen-Balance
                    </h6>
                    <div class="row">
                        <!-- Chart auf der linken Seite -->
                        <div class="col-md-7">
                            <canvas id="muskelgruppenChart" style="max-height: 400px;"></canvas>
                        </div>
                        <!-- SVG auf der rechten Seite -->
                        <div class="col-md-5">
                            <div class="text-center mb-2">
                                <small class="text-muted">Belastungsverteilung</small>
                            </div>
                            <div id="svgBalanceWrapper" style="max-width: 100%; height: 400px; overflow: hidden;">
                                <!-- SVG wird hier dynamisch geladen -->
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    <span style="display: inline-block; width: 40px; height: 12px; background: linear-gradient(to right, #d9d9d9, #ff0000); border: 1px solid #666; border-radius: 2px; vertical-align: middle;"></span>
                                    <span class="ms-2">Niedrig → Hoch</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trainings-Heatmap -->
            <div class="card card-stat border-secondary mb-4">
                <div class="card-body">
                    <h6 class="text-secondary text-uppercase mb-3">
                        <i class="bi bi-calendar-check me-2"></i>Trainings-Aktivität (letzte 90 Tage)
                    </h6>
                    <div id="heatmap" style="min-height: 150px;"></div>
                    <small class="text-muted d-block mt-2 text-center">
                        <i class="bi bi-square-fill text-secondary me-1" style="font-size: 0.6rem;"></i> Kein Training
                        <i class="bi bi-square-fill ms-3" style="color: rgba(25, 135, 84, 0.3); font-size: 0.6rem;"></i> 1 Training
                        <i class="bi bi-square-fill" style="color: rgba(25, 135, 84, 0.6); font-size: 0.6rem;"></i> 2 Trainings
                        <i class="bi bi-square-fill" style="color: rgba(25, 135, 84, 1); font-size: 0.6rem;"></i> 3+ Trainings
                    </small>
                </div>
            </div>

            <!-- Detaillierte Muskelgruppen-Tabelle -->
            <div class="card card-stat border-secondary mb-4">
                <div class="card-header border-secondary">
                    <h6 class="mb-0 text-white">Muskelgruppen-Details</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead class="text-secondary small">
                            <tr>
                                <th>Muskelgruppe</th>
                                <th class="text-center">Sätze</th>
                                <th class="text-end">Eff. Wiederholungen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mg, stats in muskelgruppen_stats %}
                            <tr>
                                <td class="fw-bold">{{ mg }}</td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ stats.saetze }}</span>
                                </td>
                                <td class="text-end">
                                    <span class="text-success fw-bold">{{ stats.volumen|floatformat:0 }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Hinweis auf weitere Features -->
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Tipp:</strong> Schaue auch bei einzelnen Übungen für detaillierte Progressions-Analysen!
            </div>

        {% endif %}

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    {% if not no_data %}
    <script>
        const chartDefaults = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: true, labels: { color: '#adb5bd' } }
            },
            scales: {
                x: { ticks: { color: '#adb5bd' }, grid: { color: '#404448' } },
                y: { 
                    ticks: { color: '#adb5bd' }, 
                    grid: { color: '#404448' },
                    beginAtZero: true
                }
            }
        };

        // Volumen pro Training
        new Chart(document.getElementById('volumenChart'), {
            type: 'line',
            data: {
                labels: {{ volumen_labels_json|safe }},
                datasets: [{
                    label: 'Volumen (kg)',
                    data: {{ volumen_data_json|safe }},
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: chartDefaults
        });

        // Wöchentliches Volumen
        new Chart(document.getElementById('weeklyChart'), {
            type: 'bar',
            data: {
                labels: {{ weekly_labels_json|safe }},
                datasets: [{
                    label: 'Wochenvolumen (kg)',
                    data: {{ weekly_data_json|safe }},
                    backgroundColor: '#0dcaf0',
                    borderColor: '#0dcaf0',
                    borderWidth: 1
                }]
            },
            options: {
                ...chartDefaults,
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // Muskelgruppen-Balance
        new Chart(document.getElementById('muskelgruppenChart'), {
            type: 'bar',
            data: {
                labels: {{ mg_labels_json|safe }},
                datasets: [{
                    label: 'Effektive Wiederholungen',
                    data: {{ mg_data_json|safe }},
                    backgroundColor: [
                        '#0d6efd', '#6610f2', '#6f42c1', '#d63384', 
                        '#dc3545', '#fd7e14', '#ffc107', '#198754',
                        '#20c997', '#0dcaf0', '#6c757d', '#adb5bd'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                indexAxis: 'y',
                plugins: {
                    legend: { 
                        display: false 
                    }
                },
                scales: {
                    x: { 
                        ticks: { color: '#adb5bd' }, 
                        grid: { color: '#404448' },
                        beginAtZero: true
                    },
                    y: { 
                        ticks: { color: '#adb5bd' }, 
                        grid: { color: '#404448' }
                    }
                }
            }
        });

        // Training Heatmap
        const heatmapData = {{ heatmap_data_json|safe }};
        const heatmapContainer = document.getElementById('heatmap');
        
        // Create grid for 13 weeks (90 days)
        const today = new Date();
        const startDate = new Date(today);
        startDate.setDate(today.getDate() - 89);
        
        // Convert heatmap data to map for quick lookup
        const dateMap = {};
        heatmapData.forEach(item => {
            dateMap[item.date] = item.count;
        });
        
        // Generate grid HTML
        let html = '<div style="display: grid; grid-template-columns: repeat(13, 1fr); gap: 3px; padding: 10px;">';
        
        for (let i = 0; i < 90; i++) {
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + i);
            const dateStr = currentDate.toISOString().split('T')[0];
            const count = dateMap[dateStr] || 0;
            
            // Determine color intensity
            let color = 'rgba(108, 117, 125, 0.3)'; // No training
            if (count === 1) color = 'rgba(25, 135, 84, 0.3)';
            else if (count === 2) color = 'rgba(25, 135, 84, 0.6)';
            else if (count >= 3) color = 'rgba(25, 135, 84, 1)';
            
            const title = `${dateStr}: ${count} Training${count !== 1 ? 's' : ''}`;
            
            html += `<div style="
                aspect-ratio: 1;
                background-color: ${color};
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                cursor: pointer;
                transition: all 0.2s;
            " title="${title}" onmouseover="this.style.transform='scale(1.3)'; this.style.zIndex='10';" onmouseout="this.style.transform='scale(1)'; this.style.zIndex='1';"></div>`;
        }
        
        html += '</div>';
        heatmapContainer.innerHTML = html;

        // SVG Balance Visualization
        const svgMuscleData = {{ svg_muscle_data_json|safe }};
        
        // Lade SVG
        fetch("{% static 'core/images/muscle_map.svg' %}")
            .then(response => response.text())
            .then(svgText => {
                const wrapper = document.getElementById('svgBalanceWrapper');
                wrapper.innerHTML = svgText;
                
                const svg = wrapper.querySelector('svg');
                if (svg) {
                    svg.style.width = '100%';
                    svg.style.height = '100%';
                    svg.id = 'balanceSvg';
                    
                    // Färbe Muskeln basierend auf Intensität (grau → rot)
                    Object.keys(svgMuscleData).forEach(muscleId => {
                        const element = svg.getElementById(muscleId);
                        if (element) {
                            const intensity = svgMuscleData[muscleId]; // 0-1
                            
                            // Farbgradient: Grau (d9d9d9) bei 0 → Rot (ff0000) bei 1
                            // Berechne RGB-Werte
                            const grayR = 217, grayG = 217, grayB = 217;
                            const redR = 255, redG = 0, redB = 0;
                            
                            const r = Math.round(grayR + (redR - grayR) * intensity);
                            const g = Math.round(grayG + (redG - grayG) * intensity);
                            const b = Math.round(grayB + (redB - grayB) * intensity);
                            
                            const color = `rgb(${r}, ${g}, ${b})`;
                            
                            element.style.fill = color;
                            element.style.stroke = color;
                            element.style.strokeWidth = intensity > 0.3 ? '3' : '2';
                            element.style.opacity = intensity > 0 ? '1' : '0.5';
                        }
                    });
                    
                    // Alle nicht trainierten Muskeln grau lassen
                    svg.querySelectorAll('.muscle').forEach(el => {
                        if (!svgMuscleData[el.id]) {
                            el.style.fill = '#d9d9d9';
                            el.style.stroke = '#d9d9d9';
                            el.style.opacity = '0.3';
                        }
                    });
                }
            })
            .catch(error => console.error('Fehler beim Laden der SVG:', error));
    </script>
    {% endif %}
  </body>
</html>
