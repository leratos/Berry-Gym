<!-- AI Plan Generator Modal -->
<style>
    .ai-plan-btn {
        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        border: none;
        box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3);
        transition: all 0.3s;
    }

    .ai-plan-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(25, 135, 84, 0.4);
    }

    .plan-generator-modal .modal-dialog {
        max-width: 700px;
    }

    .cost-badge {
        background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: bold;
    }

    .progress-container {
        display: none;
        margin-top: 1rem;
    }

    .progress {
        height: 30px;
        background: #1a1d20;
    }

    .progress-bar {
        background: linear-gradient(90deg, #198754 0%, #20c997 100%);
        font-weight: bold;
        transition: width 0.5s ease;
    }

    .step-indicator {
        margin-top: 0.5rem;
        font-size: 0.875rem;
        color: #6c757d;
    }

    .plan-preview-content {
        max-height: 500px;
        overflow-y: auto;
    }

    .plan-preview-content pre {
        background: #1a1d20;
        padding: 1rem;
        border-radius: 0.25rem;
        border: 1px solid #343a40;
    }
</style>

<!-- AI Plan Generator Modal -->
<div class="modal fade plan-generator-modal" id="aiPlanGeneratorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="bi bi-robot text-success"></i> KI-Trainingsplan erstellen
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Info Badge -->
                <div class="alert alert-info border-info d-flex align-items-center mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <small>Die KI analysiert deine letzten Trainings und erstellt einen personalisierten Plan</small>
                </div>

                <!-- Form -->
                <form id="aiPlanForm">
                    <!-- Plan-Typ -->
                    <div class="mb-3">
                        <label for="planType" class="form-label">
                            <i class="bi bi-calendar-week"></i> Plan-Typ
                        </label>
                        <select class="form-select bg-dark text-white border-secondary" id="planType" name="plan_type" required>
                            <option value="3er-split" selected>3er-Split (3x/Woche)</option>
                            <option value="2er-split">2er-Split (2x/Woche)</option>
                            <option value="4er-split">4er-Split (4x/Woche)</option>
                            <option value="push-pull-legs">Push-Pull-Beine (3x/Woche)</option>
                            <option value="ganzk√∂rper">Ganzk√∂rper (2-3x/Woche)</option>
                        </select>
                        <div class="form-text">Wie oft trainierst du pro Woche?</div>
                    </div>

                    <!-- S√§tze pro Session -->
                    <div class="mb-3">
                        <label for="setsPerSession" class="form-label">
                            <i class="bi bi-bar-chart"></i> S√§tze pro Trainingstag: <strong id="setsValue">18</strong>
                        </label>
                        <input type="range" class="form-range" id="setsPerSession" name="sets_per_session"
                               min="12" max="24" value="18" step="2" oninput="updateSetsValue(this.value)">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">12 (Kurz)</small>
                            <small class="text-muted">18 (Optimal)</small>
                            <small class="text-muted">24 (Lang)</small>
                        </div>
                    </div>

                    <!-- Analyse-Zeitraum -->
                    <div class="mb-3">
                        <label for="analysisDays" class="form-label">
                            <i class="bi bi-clock-history"></i> Trainingshistorie analysieren
                        </label>
                        <select class="form-select bg-dark text-white border-secondary" id="analysisDays" name="analysis_days">
                            <option value="14">Letzte 2 Wochen</option>
                            <option value="30" selected>Letzter Monat</option>
                            <option value="60">Letzte 2 Monate</option>
                        </select>
                    </div>

                    <!-- Periodisierung -->
                    <div class="mb-3">
                        <label for="periodization" class="form-label">
                            <i class="bi bi-arrow-repeat"></i> Periodisierung
                        </label>
                        <select class="form-select bg-dark text-white border-secondary" id="periodization" name="periodization">
                            <option value="linear" selected>Linear (Progressive Steigerung)</option>
                            <option value="wellenfoermig">Wellenf√∂rmig (Heavy/Medium/Light)</option>
                            <option value="block">Block (Volumen ‚Üí Kraft ‚Üí Peak)</option>
                        </select>
                        <div class="form-text">12 Wochen mit Deload in Woche 4/8/12</div>
                    </div>

                    <!-- Zielprofil -->
                    <div class="mb-3">
                        <label for="targetProfile" class="form-label">
                            <i class="bi bi-bullseye"></i> Trainingsziel
                        </label>
                        <select class="form-select bg-dark text-white border-secondary" id="targetProfile" name="target_profile">
                            <option value="kraft">Kraft (3-6 Wdh, RPE 7.5-9)</option>
                            <option value="hypertrophie" selected>Muskelaufbau (6-12 Wdh, RPE 7-8.5)</option>
                            <option value="definition">Definition (10-15 Wdh, RPE 6.5-8)</option>
                        </select>
                        <div class="form-text">Bestimmt RPE- und Wiederholungs-Zonen</div>
                    </div>

                    <!-- Submit Button - Text je nach Modus -->
                    <button type="submit" class="btn btn-success w-100 fw-bold" id="generateBtn">
                        <i class="bi bi-stars"></i>
                        {% if use_openrouter %}
                            Vorschau erstellen
                        {% else %}
                            Plan generieren & speichern
                        {% endif %}
                    </button>
                    {% if not use_openrouter %}
                    <small class="text-muted d-block text-center mt-2">
                        <i class="bi bi-cpu"></i> Lokale KI - Plan wird direkt gespeichert
                    </small>
                    {% endif %}
                </form>

                <!-- Plan Preview Container (initially hidden) -->
                <div id="planPreviewContainer" style="display: none;">
                    <hr class="my-4 border-secondary">
                    <h6 class="text-success mb-3"><i class="bi bi-eye"></i> Plan-Vorschau</h6>
                    <div id="planPreviewContent" class="plan-preview-content">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <div class="d-flex gap-2 mt-3">
                        <button type="button" class="btn btn-success flex-fill" id="confirmSaveBtn">
                            <i class="bi bi-save"></i> Plan speichern
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelPreviewBtn">
                            <i class="bi bi-x-circle"></i> Abbrechen
                        </button>
                    </div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="setAsActiveCheck" checked>
                        <label class="form-check-label text-warning" for="setAsActiveCheck">
                            <i class="bi bi-star-fill"></i> Als aktiven Plan setzen
                            <small class="text-muted d-block ms-0 mt-1">
                                Ersetzt den aktuellen Wochenzyklus. Deaktivieren um den neuen Plan nur zu speichern, ohne den laufenden Zyklus zu √§ndern.
                            </small>
                        </label>
                    </div>
                </div>

                <!-- Progress Container (initially hidden) -->
                <div class="progress-container" id="progressContainer">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" id="progressBar" style="width: 0%">
                            0%
                        </div>
                    </div>
                    <div class="step-indicator text-center" id="stepIndicator">
                        <i class="bi bi-hourglass-split"></i> Starte Generierung...
                    </div>
                </div>

                <!-- Success Message (initially hidden) -->
                <div class="alert alert-success border-success mt-3" id="successMessage" style="display: none;">
                    <i class="bi bi-check-circle"></i> <strong>Erfolg!</strong>
                    <p class="mb-0 mt-2" id="successText"></p>
                </div>

                <!-- Error Message (initially hidden) -->
                <div class="alert alert-danger border-danger mt-3" id="errorMessage" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Fehler!</strong>
                    <p class="mb-0 mt-2" id="errorText"></p>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schlie√üen</button>
            </div>
        </div>
    </div>
</div>

<script>
    // AI Plan Generator ‚Äì SSE-basierter Echtzeit-Progress
    (function() {
        const aiPlanForm = document.getElementById('aiPlanForm');
        const generateBtn = document.getElementById('generateBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const stepIndicator = document.getElementById('stepIndicator');
        const successMessage = document.getElementById('successMessage');
        const successText = document.getElementById('successText');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const planPreviewContainer = document.getElementById('planPreviewContainer');
        const planPreviewContent = document.getElementById('planPreviewContent');
        const confirmSaveBtn = document.getElementById('confirmSaveBtn');
        const cancelPreviewBtn = document.getElementById('cancelPreviewBtn');

        const useOpenRouter = {{ use_openrouter|yesno:"true,false" }};
        const skipPreview = !useOpenRouter;

        let currentPlanData = null;
        let activeEventSource = null;

        window.updateSetsValue = function(value) {
            document.getElementById('setsValue').textContent = value;
        };

        cancelPreviewBtn.addEventListener('click', function() {
            planPreviewContainer.style.display = 'none';
            aiPlanForm.style.display = 'block';
            generateBtn.disabled = false;
            currentPlanData = null;
        });

        confirmSaveBtn.addEventListener('click', async function() {
            if (!currentPlanData) return;

            confirmSaveBtn.disabled = true;
            cancelPreviewBtn.disabled = true;
            progressContainer.style.display = 'block';
            setProgress(50, 'üíæ Speichere Plan...');

            try {
                const response = await fetch('{% url "generate_plan_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        ...currentPlanData,
                        set_as_active: document.getElementById('setAsActiveCheck').checked,
                    })
                });
                const data = await response.json();
                setProgress(100, '‚úÖ Gespeichert!');
                progressBar.classList.remove('progress-bar-animated');

                if (data.success) {
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        successMessage.style.display = 'block';
                        successText.innerHTML = `${data.message || 'Plan erfolgreich gespeichert!'}<br>
                            <strong>${data.sessions || 'Mehrere'} Trainingstage</strong> erstellt`;
                        planPreviewContainer.style.display = 'none';
                        setTimeout(() => {
                            if (data.plan_ids && data.plan_ids.length > 0) {
                                window.location.href = `/plan/${data.plan_ids[0]}/`;
                            } else {
                                window.location.reload();
                            }
                        }, 2000);
                    }, 500);
                } else {
                    showError(data.error || 'Fehler beim Speichern');
                    confirmSaveBtn.disabled = false;
                    cancelPreviewBtn.disabled = false;
                }
            } catch (err) {
                showError('Netzwerkfehler beim Speichern');
                confirmSaveBtn.disabled = false;
                cancelPreviewBtn.disabled = false;
            }
        });

        aiPlanForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Cleanup falls noch ein alter Stream offen ist
            if (activeEventSource) {
                activeEventSource.close();
                activeEventSource = null;
            }

            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            planPreviewContainer.style.display = 'none';
            progressContainer.style.display = 'block';
            progressBar.classList.add('progress-bar-animated');
            generateBtn.disabled = true;

            const planType = document.getElementById('planType').value;
            const setsPerSession = document.getElementById('setsPerSession').value;
            const analysisDays = document.getElementById('analysisDays').value;
            const periodization = document.getElementById('periodization').value;
            const targetProfile = document.getElementById('targetProfile').value;

            if (skipPreview) {
                // Lokal (Ollama): klassischer POST, kein SSE
                runDirectPost({
                    plan_type: planType,
                    sets_per_session: parseInt(setsPerSession),
                    analysis_days: parseInt(analysisDays),
                    periodization: periodization,
                    target_profile: targetProfile,
                    previewOnly: false,
                });
                return;
            }

            // OpenRouter: Echtzeit-Progress via SSE
            const params = new URLSearchParams({
                plan_type: planType,
                sets_per_session: setsPerSession,
                analysis_days: analysisDays,
                periodization: periodization,
                target_profile: targetProfile,
            });

            setProgress(0, 'üöÄ Starte Plan-Generierung...');

            const es = new EventSource(`{% url "generate_plan_stream_api" %}?${params}`);
            activeEventSource = es;

            es.onmessage = function(event) {
                let data;
                try {
                    data = JSON.parse(event.data);
                } catch(e) {
                    return;
                }

                if (!data.done) {
                    setProgress(data.progress || 0, data.step || '...');
                    return;
                }

                // Stream fertig
                es.close();
                activeEventSource = null;

                if (data.success && data.preview) {
                    setProgress(100, '‚úÖ Vorschau bereit!');
                    progressBar.classList.remove('progress-bar-animated');
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        aiPlanForm.style.display = 'none';
                        planPreviewContainer.style.display = 'block';
                        currentPlanData = {
                            plan_data: data.plan_data,
                            saveCachedPlan: true,
                        };
                        renderPreview(data.plan_data, data.coverage_warnings || []);
                    }, 400);
                } else if (data.success && !data.preview) {
                    // Direktspeicherung (Fallback ohne Preview)
                    setProgress(100, '‚úÖ Plan erstellt!');
                    progressBar.classList.remove('progress-bar-animated');
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        successMessage.style.display = 'block';
                        successText.innerHTML = `Plan erfolgreich erstellt!`;
                        setTimeout(() => window.location.reload(), 2000);
                    }, 400);
                } else {
                    progressContainer.style.display = 'none';
                    showError(data.error || 'Fehler bei der Plan-Generierung');
                    generateBtn.disabled = false;
                }
            };

            es.onerror = function() {
                es.close();
                activeEventSource = null;
                progressContainer.style.display = 'none';
                showError('Verbindung unterbrochen. Bitte erneut versuchen.');
                generateBtn.disabled = false;
            };
        });

        async function runDirectPost(formData) {
            // Fake-Progress f√ºr lokale Ollama-Anfragen (kein SSE)
            const steps = [
                { progress: 25, text: 'üìä Analysiere Trainingshistorie...' },
                { progress: 50, text: 'ü§ñ KI erstellt Plan...' },
                { progress: 75, text: '‚úÖ Validiere √úbungen...' },
                { progress: 90, text: 'üíæ Speichere Plan...' },
            ];
            let stepIdx = 0;
            const interval = setInterval(() => {
                if (stepIdx < steps.length) {
                    const s = steps[stepIdx++];
                    setProgress(s.progress, s.text);
                }
            }, 1500);

            try {
                const response = await fetch('{% url "generate_plan_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(formData)
                });
                clearInterval(interval);
                const data = await response.json();

                if (data.success) {
                    setProgress(100, '‚úÖ Gespeichert!');
                    progressBar.classList.remove('progress-bar-animated');
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        successMessage.style.display = 'block';
                        successText.innerHTML = `${data.message || 'Plan gespeichert!'}<br>
                            <strong>${data.sessions || 'Mehrere'} Trainingstage</strong> erstellt`;
                        setTimeout(() => {
                            if (data.plan_ids && data.plan_ids.length > 0) {
                                window.location.href = `/plan/${data.plan_ids[0]}/`;
                            } else {
                                window.location.href = '/plaene/';
                            }
                        }, 2000);
                    }, 500);
                } else {
                    progressContainer.style.display = 'none';
                    showError(data.error || 'Fehler bei der Plan-Generierung');
                    generateBtn.disabled = false;
                }
            } catch(err) {
                clearInterval(interval);
                progressContainer.style.display = 'none';
                showError('Netzwerkfehler. Bitte erneut versuchen.');
                generateBtn.disabled = false;
            }
        }

        function setProgress(percent, text) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            stepIndicator.innerHTML = text;
        }

        function showError(msg) {
            errorMessage.style.display = 'block';
            errorText.textContent = msg;
        }

        function renderPreview(planData, coverageWarnings) {
            if (!planData || !planData.sessions) {
                planPreviewContent.innerHTML = '<p class="text-muted">Keine Daten verf√ºgbar</p>';
                return;
            }

            let html = `<div class="alert alert-info mb-3">
                <strong>${planData.plan_name || 'Trainingsplan'}</strong>
            </div>`;

            // Coverage-Warnungen anzeigen (nicht abgedeckte Schwachstellen)
            if (coverageWarnings && coverageWarnings.length > 0) {
                html += `<div class="alert alert-warning border-warning mb-3">
                    <h6 class="mb-2"><i class="bi bi-exclamation-triangle-fill"></i> Schwachstellen nicht abgedeckt</h6>
                    <ul class="mb-0 ps-3">`;
                coverageWarnings.forEach(w => {
                    // Entferne das f√ºhrende "‚ö†Ô∏è Schwachstelle nicht abgedeckt: " f√ºr saubere Darstellung
                    const text = w.replace(/^‚ö†Ô∏è\s*Schwachstelle nicht abgedeckt:\s*/, '');
                    html += `<li><small>${text}</small></li>`;
                });
                html += `</ul>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle"></i> Der Plan ist trotzdem verwendbar. Generiere einen neuen Plan oder erg√§nze diese √úbungen manuell.
                    </small>
                </div>`;
            }

            if (planData.beschreibung) {
                html += `<div class="card bg-dark border-secondary mb-3">
                    <div class="card-body">
                        <h6 class="card-title text-success">üìã Beschreibung & Periodisierung</h6>
                        <pre class="text-white mb-0" style="white-space: pre-wrap; font-size: 0.85rem;">${planData.beschreibung}</pre>
                    </div>
                </div>`;
            }

            planData.sessions.forEach((session, idx) => {
                html += `<div class="card bg-dark border-secondary mb-3">
                    <div class="card-header bg-secondary">
                        <strong>Tag ${idx + 1}: ${session.day_name || `Trainingstag ${idx + 1}`}</strong>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">`;

                session.exercises.forEach(ex => {
                    const restInfo = ex.rest_seconds
                        ? `<span class="badge bg-warning text-dark ms-2"><i class="bi bi-stopwatch"></i> ${ex.rest_seconds}s</span>`
                        : '';
                    html += `<li class="mb-2">
                        <i class="bi bi-check-circle text-success"></i>
                        <strong>${ex.exercise_name}</strong> ‚Äì
                        ${ex.sets} S√§tze √ó ${ex.reps} Wdh
                        ${ex.rpe_target ? `@ RPE ${ex.rpe_target}` : ''}
                        ${restInfo}
                        ${ex.notes ? `<br><small class="text-muted ms-4">${ex.notes}</small>` : ''}
                    </li>`;
                });

                html += `</ul></div></div>`;
            });

            planPreviewContent.innerHTML = html;
        }
    })();
</script>
