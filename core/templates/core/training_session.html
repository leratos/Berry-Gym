{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{# === HEAD: nur page-spezifisches CSS === #}
{% block extra_head %}
<!-- Toast Notification System -->
    <link rel="stylesheet" href="{% static 'core/css/toast.css' %}">

<style>
        /* Superset-Gruppierung */
        .superset-group-1 { border-left: 4px solid #ffc107 !important; }
        .superset-group-2 { border-left: 4px solid #0dcaf0 !important; }
        .superset-group-3 { border-left: 4px solid #d63384 !important; }
        .superset-group-4 { border-left: 4px solid #6610f2 !important; }
        .superset-group-5 { border-left: 4px solid #20c997 !important; }

        .rest-timer {
            position: fixed;
            bottom: 90px;
            right: 20px;
            z-index: 1050;
        }
        .timer-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(0,0,0,0.5);
            border: 3px solid rgba(255,255,255,0.2);
        }
        .timer-circle small {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 2px;
        }
        .timer-running {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        /* Theme-aware Training Navbar */
        .navbar-training {
            background-color: var(--bs-body-bg);
            border-bottom-color: var(--bs-border-color) !important;
        }

        [data-bs-theme="dark"] .navbar-training {
            background-color: #1a1d21;
            border-bottom-color: #30363d !important;
        }

        [data-bs-theme="light"] .navbar-training {
            background-color: #f8f9fa;
            border-bottom-color: #dee2e6 !important;
        }

        .training-title {
            color: var(--bs-body-color);
        }

        [data-bs-theme="dark"] .training-title {
            color: #e9ecef;
        }

        [data-bs-theme="light"] .training-title {
            color: #212529;
        }

        /* Undo Toast Styling */
        .toast-undo {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            animation: slideInRight 0.3s ease-out;
        }

        [data-bs-theme="light"] .toast-undo {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #212529;
            border: 1px solid #dee2e6;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes countdown {
            from { width: 100%; }
            to { width: 0%; }
        }

        .dropdown-menu-theme {
            background-color: var(--bs-body-bg);
            border-color: var(--bs-border-color);
        }

        [data-bs-theme="dark"] .dropdown-menu-theme {
            background-color: #1a1d21;
            border-color: #30363d;
        }

        [data-bs-theme="light"] .dropdown-menu-theme {
            background-color: #ffffff;
            border-color: #dee2e6;
        }

        .dropdown-menu-theme .dropdown-item {
            color: var(--bs-body-color);
        }

        .dropdown-menu-theme .dropdown-item:hover {
            background-color: var(--bs-secondary-bg);
        }

        [data-bs-theme="dark"] .dropdown-menu-theme .dropdown-item:hover {
            background-color: #30363d;
        }

        [data-bs-theme="light"] .dropdown-menu-theme .dropdown-item:hover {
            background-color: #e9ecef;
        }

        .dropdown-menu-theme .dropdown-divider {
            border-color: var(--bs-border-color);
        }

        .dropdown-menu-theme .dropdown-header {
            color: var(--bs-secondary-color);
        }

        /* Mobile-optimierte Navbar */
        @media (max-width: 576px) {
            .training-navbar {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0.5rem !important;
            }
            .training-navbar .navbar-text {
                order: -1;
                width: 100%;
                text-align: center;
                margin-bottom: 0.25rem;
                font-size: 0.9rem;
            }
            .training-navbar .nav-actions {
                display: flex;
                justify-content: space-between;
                width: 100%;
                gap: 0.25rem;
            }
            .training-navbar .btn {
                padding: 0.375rem 0.5rem;
                font-size: 0.85rem;
            }
            .training-navbar .btn-group .btn {
                padding: 0.375rem 0.4rem;
            }
            /* Timer-Text auf mobil ausblenden */
            .training-navbar .timer-text {
                display: none;
            }
        }
    </style>
{% endblock extra_head %}

{# === HEADER: Global-Nav + Training-spezifische Toolbar === #}
{% block header %}
    {% include 'core/includes/global_header.html' %}

    <nav class="navbar navbar-training border-bottom mb-3 shadow">
      <div class="container-fluid training-navbar">
        <span class="navbar-text fw-bold training-title">
            Training #{{ training.id }}
        </span>
        <div class="nav-actions d-flex gap-2">
            <a class="btn btn-outline-secondary border-0" href="{% url 'training_select_plan' %}" title="Abbrechen">
                <i class="bi bi-arrow-left"></i><span class="d-none d-sm-inline"> Abbrechen</span>
            </a>
            <!-- Rest Timer Dropdown -->
            <div class="btn-group">
                <button class="btn btn-outline-warning border-0" onclick="startRestTimer()" title="Pausenuhr starten">
                    <i class="bi bi-stopwatch"></i>
                </button>
                <button class="btn btn-outline-warning border-0 dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false" title="Timer-Dauer w√§hlen">
                    <span class="visually-hidden">Timer-Dauer</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-theme dropdown-menu-end" style="min-width: 250px;">
                    <li><h6 class="dropdown-header">Pausendauer</h6></li>
                    <li><a class="dropdown-item" href="#" onclick="setTimerDuration(60); return false;">
                        <i class="bi bi-clock"></i> 60 Sekunden
                    </a></li>
                    <li><a class="dropdown-item active" href="#" onclick="setTimerDuration(90); return false;">
                        <i class="bi bi-clock"></i> 90 Sekunden
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="setTimerDuration(120); return false;">
                        <i class="bi bi-clock"></i> 120 Sekunden
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="setTimerDuration(180); return false;">
                        <i class="bi bi-clock"></i> 180 Sekunden
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">Sound-Einstellungen</h6></li>
                    <li class="px-3 py-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="soundToggle" checked onchange="toggleSound()">
                            <label class="form-check-label" for="soundToggle">
                                <i class="bi bi-volume-up"></i> Sound aktiv
                            </label>
                        </div>
                    </li>
                    <li class="px-3 py-2">
                        <label for="volumeSlider" class="form-label small">
                            <i class="bi bi-volume-down"></i> Lautst√§rke: <span id="volumeValue">30</span>%
                        </label>
                        <input type="range" class="form-range" id="volumeSlider" min="0" max="100" value="30" oninput="updateVolume(this.value)">
                    </li>
                </ul>
            </div>
            <a class="btn btn-success border-0 fw-bold" href="{% url 'finish_training' training.id %}" title="Training beenden">
                <i class="bi bi-check-circle"></i><span class="d-none d-sm-inline"> Fertig</span>
            </a>
            <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary border-0" title="Theme wechseln">
              <i class="bi bi-moon-fill" id="themeIcon"></i>
            </button>
        </div>
      </div>
    </nav>
{% endblock header %}

{# === CONTENT === #}
{% block content %}
    <div class="container pb-5 mb-5">

        <!-- Deload-Toggle -->
        <div class="alert {% if training.ist_deload %}alert-info{% else %}alert-dark{% endif %} border-secondary d-flex justify-content-between align-items-center mb-2 py-2" id="deloadBanner">
            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="deloadToggle"
                       {% if training.ist_deload %}checked{% endif %}
                       onchange="toggleDeload(this.checked)">
                <label class="form-check-label small" for="deloadToggle">
                    <i class="bi bi-arrow-down-circle"></i> Deload-Training
                </label>
            </div>
            <small class="text-muted" id="deloadHint">
                {% if training.ist_deload %}
                    <i class="bi bi-info-circle"></i> Wird nicht in Statistik gez√§hlt
                {% else %}
                    {% if is_deload_week %}
                        <i class="bi bi-info-circle"></i> Empfohlene Deload-Woche ‚Äì z√§hlt aktuell zur Statistik
                    {% else %}
                        Z√§hlt f√ºr Statistik
                    {% endif %}
                {% endif %}
            </small>
        </div>

        <!-- Volumen-Anzeige -->
        {% if saetze %}
        <div class="alert alert-dark border-secondary d-flex justify-content-between align-items-center mb-3">
            <div>
                <small class="text-secondary text-uppercase" style="font-size: 0.7rem;">Gesamtvolumen heute</small>
                <div class="fs-4 fw-bold text-success">{{ total_volume|floatformat:0 }} kg</div>
            </div>
            <div class="text-end">
                <small class="text-muted">{{ arbeitssaetze_count }} Arbeitss√§tze</small>
            </div>
        </div>
        {% endif %}

        {% if not saetze %}
            <div class="text-center py-5 text-muted">
                <i class="bi bi-dumbbell display-1 opacity-25"></i>
                <p class="mt-3">Dr√ºck auf +, um loszulegen!</p>
            </div>
        {% else %}

            {% regroup saetze by uebung as uebungs_liste %}

            {% for uebung_group in uebungs_liste %}
            <div class="card card-stat border-secondary mb-3 shadow-sm">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center bg-secondary bg-opacity-10">
                    <div class="d-flex align-items-center">
                        <h5 class="mb-0 text-primary fw-bold me-2">
                            <a href="#" class="text-decoration-none text-primary exercise-link"
                               data-exercise-id="{{ uebung_group.grouper.id }}"
                               title="√úbungsdetails anzeigen">
                                {{ uebung_group.grouper }}
                                <i class="bi bi-info-circle-fill"></i>
                            </a>
                        </h5>
                        <!-- NEU: Der Statistik-Link -->
                        <a href="{% url 'exercise_stats' uebung_group.grouper.id %}" class="text-decoration-none text-info opacity-50">
                            <i class="bi bi-graph-up"></i>
                        </a>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        {% if training.plan and plan_ziele %}
                            {% with ziel=plan_ziele|get_item:uebung_group.grouper.id %}
                                {% if ziel %}
                                <span class="badge bg-info text-dark">
                                    <i class="bi bi-bullseye me-1"></i>Ziel: {{ ziel.saetze_ziel }}√ó{{ ziel.wiederholungen_ziel }}
                                </span>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                        <span class="badge bg-secondary">{{ uebung_group.list|length }} S√§tze</span>
                    </div>
                </div>
                <!-- Gewichtsempfehlung -->
                {% if gewichts_empfehlungen %}
                    {% with empf=gewichts_empfehlungen|get_item:uebung_group.grouper.id %}
                        {% if empf %}
                        <div class="px-3 py-2 bg-dark bg-opacity-50 border-bottom border-secondary">
                            <small class="text-info">
                                <i class="bi bi-cpu-fill me-1"></i>
                                <strong>ML-Empfehlung:</strong> {{ empf.gewicht }} kg √ó {{ empf.wdh }}
                                <button class="btn btn-sm {% if empf.pause_from_plan %}btn-warning{% else %}btn-outline-warning{% endif %} py-0 px-2 ms-2"
                                        onclick="setTimerDuration({{ empf.pause }}); startRestTimer();"
                                        title="{% if empf.pause_from_plan %}Pause aus KI-Plan{% else %}Berechnete Pause{% endif %} - Klick zum Starten">
                                    <i class="bi bi-stopwatch"></i> {{ empf.pause }}s
                                    {% if empf.pause_from_plan %}<i class="bi bi-robot ms-1" style="font-size: 0.7rem;"></i>{% endif %}
                                </button>
                                <span class="text-muted ms-2">
                                    ({{ empf.hint }})
                                </span>
                            </small>
                        </div>
                        {% endif %}
                    {% endwith %}
                {% endif %}

                <div class="card-body p-0">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="text-secondary small text-uppercase">
                            <tr>
                                <th class="ps-3" style="width: 10%">#</th>
                                <th style="width: 30%">kg</th>
                                <th style="width: 30%">Wdh / Sek</th>
                                <th class="text-end pe-3">Aktion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for satz in uebung_group.list %}
                            <tr class="{% if satz.ist_aufwaermsatz %}text-muted fst-italic{% endif %} {% if satz.superset_gruppe > 0 %}superset-group-{{ satz.superset_gruppe }}{% endif %}">
                                <td class="ps-3">
                                    {% if satz.superset_gruppe > 0 %}
                                        <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">S{{ satz.superset_gruppe }}</span>
                                    {% elif satz.ist_aufwaermsatz %}
                                        <i class="bi bi-fire text-warning small" title="Warmup"></i>
                                    {% else %}
                                        <span class="fw-bold text-secondary">{{ forloop.counter }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="fw-bold fs-5">{{ satz.gewicht }}</span>
                                    {% if satz.notiz %}
                                        <span class="badge bg-info ms-1" title="{{ satz.notiz }}">
                                            <i class="bi bi-chat-left-text"></i>
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="fw-bold fs-5">{{ satz.wiederholungen }}</span>
                                    {% if satz.rpe %}
                                        <small class="text-muted ms-1">@{{ satz.rpe }}</small>
                                    {% endif %}
                                    {% if satz.notiz %}
                                        <div class="small text-muted mt-1 px-2 py-1 bg-dark rounded" style="font-size: 0.7rem;">
                                            <i class="bi bi-chat-left-text me-1"></i>{{ satz.notiz|truncatewords:15 }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-3 text-nowrap">
                                    <!-- TIMER BUTTON -->
                                    <button class="btn btn-link text-warning opacity-75 text-decoration-none px-1"
                                            onclick="startRestTimer()" title="Pausenuhr starten">
                                        <i class="bi bi-stopwatch"></i>
                                    </button>

                                    <!-- EDIT BUTTON -->
                                    <button class="btn btn-link text-info opacity-75 text-decoration-none px-2"
                                            onclick="openEditModal('{{ satz.id }}', '{{ satz.uebung.id }}', '{{ satz.gewicht }}', '{{ satz.wiederholungen }}', '{{ satz.rpe|default_if_none:'' }}', '{{ satz.ist_aufwaermsatz|yesno:'true,false' }}', '{{ satz.notiz|default_if_none:''|escapejs }}', '{{ satz.superset_gruppe }}')">>
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>

                                    <!-- DELETE BUTTON -->
                                    <button class="btn btn-link text-danger opacity-50 text-decoration-none px-2"
                                            onclick="confirmDelete('{{ satz.id }}', '{{ satz.uebung.bezeichnung }}', '{{ satz.gewicht }}', '{{ satz.wiederholungen }}')">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <div class="d-grid p-2 border-top border-secondary">
                        {% with last_satz=uebung_group.list|last %}
                        <button class="btn btn-sm btn-outline-secondary border-0 text-start ps-3"
                                data-exercise-id="{{ uebung_group.grouper.id }}"
                                data-last-superset="{{ last_satz.superset_gruppe|default:0 }}"
                                onclick="openModalWithExercise('{{ uebung_group.grouper.id }}', this.dataset.lastSuperset)">
                            <i class="bi bi-plus-circle me-2"></i> Weiteren Satz hinzuf√ºgen
                        </button>
                        {% endwith %}
                    </div>
                </div>
            </div>
            {% endfor %}

        {% endif %}

        <div class="fixed-bottom p-3 text-end">
            <button class="btn btn-primary rounded-circle shadow p-3" style="width: 60px; height: 60px;" onclick="openModalWithExercise('')">
                <i class="bi bi-plus-lg fs-4"></i>
            </button>
        </div>

        <!-- PR Toast Container -->
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11000;">
            <div id="prToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-success text-white">
                    <i class="bi bi-trophy-fill me-2"></i>
                    <strong class="me-auto">Neuer Personal Record!</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body card-stat" id="prToastBody">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>

        <!-- Rest Timer -->
        <div class="rest-timer" id="restTimer" style="display: none;">
            <div class="timer-circle bg-warning text-dark" id="timerDisplay" onclick="stopTimer()">
                <div id="timerSeconds">90</div>
                <small>Pause</small>
            </div>
        </div>

    </div>

    <!-- DAS MODAL -->
    <div class="modal fade" id="addSetModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content card-stat shadow">
          <div class="modal-header border-secondary">
            <h5 class="modal-title" id="modalTitle">Satz hinzuf√ºgen</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <form method="post" id="setForm" action="">
            {% csrf_token %}
            <div class="modal-body">

                <div class="mb-3">
                    <label class="form-label text-secondary small text-uppercase">√úbung suchen</label>
                    <input type="text" id="exerciseSearchInput" class="form-control border-secondary mb-3" placeholder="Bankdr√ºcken, Kniebeugen, ...">
                </div>

                <div class="mb-3">
                    <label class="form-label text-secondary small text-uppercase">1. Muskelgruppe</label>
                    <select id="muscleFilter" class="form-select border-secondary mb-2">
                        <option value="">-- Bitte w√§hlen --</option>
                        {% regroup uebungen by get_muskelgruppe_display as muskel_liste %}
                        {% for group in muskel_liste %}
                            <option value="{{ group.list.0.muskelgruppe }}">{{ group.grouper }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label text-secondary small text-uppercase">2. √úbung</label>
                    <select name="uebung" id="uebungSelect" class="form-select border-secondary" required disabled>
                        <option value="" selected disabled>-- Erst Muskelgruppe w√§hlen --</option>
                    </select>
                </div>

                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label text-secondary">Gewicht (kg)</label>
                        <input type="number" step="0.5" name="gewicht" id="gewichtInput" class="form-control border-secondary" required placeholder="0.0">
                    </div>
                    <div class="col-6">
                        <label class="form-label text-secondary">Wdh. / Sek.</label>
                        <input type="number" name="wiederholungen" id="wdhInput" class="form-control border-secondary" required placeholder="0">
                    </div>
                </div>

                <div class="row g-2 mt-2">
                    <div class="col-6">
                        <label class="form-label text-secondary">RPE</label>
                        <input type="number" step="0.5" max="10" name="rpe" id="rpeInput" class="form-control border-secondary" placeholder="-">
                    </div>
                    <div class="col-6">
                        <label class="form-label text-secondary">Superset</label>
                        <select name="superset_gruppe" id="supersetInput" class="form-select border-secondary">
                            <option value="0">Keine</option>
                            <option value="1">S1</option>
                            <option value="2">S2</option>
                            <option value="3">S3</option>
                            <option value="4">S4</option>
                            <option value="5">S5</option>
                        </select>
                    </div>
                </div>

                <div class="row g-2 mt-2">
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="ist_aufwaermsatz" id="warmupCheck">
                            <label class="form-check-label text-secondary" for="warmupCheck">
                                <i class="bi bi-fire me-1"></i> Aufw√§rmsatz
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Notiz -->
                <div class="mt-3">
                    <label class="form-label text-secondary">
                        <i class="bi bi-pencil-square me-1"></i>Notiz (optional)
                    </label>

                    <!-- Quick Tags -->
                    <div class="btn-group btn-group-sm mb-2 flex-wrap" role="group" aria-label="Quick Tags">
                        <button type="button" class="btn btn-outline-success" onclick="insertTag('‚≠ê Perfekt')">‚≠ê Perfekt</button>
                        <button type="button" class="btn btn-outline-info" onclick="insertTag('üëç Gut')">üëç Gut</button>
                        <button type="button" class="btn btn-outline-warning" onclick="insertTag('‚ö†Ô∏è Schwierig')">‚ö†Ô∏è Schwierig</button>
                        <button type="button" class="btn btn-outline-danger" onclick="insertTag('ü§ï Mit Hilfe')">ü§ï Mit Hilfe</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertTag('üòì Schmerz')">üòì Schmerz</button>
                    </div>

                    <textarea name="notiz" id="notizInput" class="form-control border-secondary" rows="3"
                              placeholder="z.B. 'Letzte 2 Wdh. mit Hilfe', 'Grip zu eng', 'Neue Schuhe'..."
                              maxlength="500" oninput="updateCharCount()"></textarea>
                    <div class="d-flex justify-content-between align-items-center mt-1">
                        <small class="text-muted" id="charCount">0 / 500 Zeichen</small>
                        <button type="button" class="btn btn-sm btn-link text-muted p-0" onclick="clearNotiz()">
                            <i class="bi bi-x-circle"></i> L√∂schen
                        </button>
                    </div>
                </div>

                <!-- Progressive Overload Hinweis -->
                <div id="progressionHint" class="alert alert-info mt-3 py-2 px-3" style="display: none;">
                    <small>
                        <i class="bi bi-lightbulb-fill me-1"></i>
                        <strong>Tipp:</strong> <span id="progressionText"></span>
                    </small>
                </div>

            </div>
            <div class="modal-footer border-secondary">
                <button type="submit" class="btn btn-primary w-100 fw-bold">Speichern</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content card-stat border-danger">
          <div class="modal-header border-danger">
            <h5 class="modal-title text-danger">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>Satz l√∂schen?
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="mb-2">M√∂chtest du diesen Satz wirklich l√∂schen?</p>
            <div class="alert alert-secondary mb-0">
                <strong id="deleteExerciseName"></strong><br>
                <span id="deleteSetDetails" class="text-muted"></span>
            </div>
          </div>
          <div class="modal-footer border-secondary">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
            <a href="#" id="confirmDeleteBtn" class="btn btn-danger">
                <i class="bi bi-trash-fill me-1"></i> Ja, l√∂schen
            </a>
          </div>
        </div>
      </div>
    </div>

{% endblock content %}

{# === SCRIPTS === #}
{% block extra_scripts %}
    <script src="{% static 'core/js/loading-manager.js' %}"></script>
    <script src="{% static 'core/js/keyboard-shortcuts.js' %}"></script>
    <script src="{% static 'core/js/exercise-autocomplete.js' %}"></script>

    <script>
        // Training Context f√ºr Keyboard Shortcuts
        document.body.dataset.context = 'training';

        // Daten f√ºr Filter
        // FIX: |escapejs verhindert Abst√ºrze bei Namen wie "Farmer's Walk"
        const allExercises = [
            {% for uebung in uebungen %}
            {
                id: "{{ uebung.id }}",
                name: "{{ uebung.bezeichnung|escapejs }}",
                muscleKey: "{{ uebung.muskelgruppe|escapejs }}"
            },
            {% endfor %}
        ];

        const myModalEl = document.getElementById('addSetModal');
        const myModal = new bootstrap.Modal(myModalEl);
        const deleteModalEl = document.getElementById('deleteModal');
        const deleteModal = new bootstrap.Modal(deleteModalEl);

        const setForm = document.getElementById('setForm');
        const modalTitle = document.getElementById('modalTitle');

        const muscleFilter = document.getElementById('muscleFilter');
        const uebungSelect = document.getElementById('uebungSelect');
        const gewichtInput = document.getElementById('gewichtInput');
        const wdhInput = document.getElementById('wdhInput');
        const rpeInput = document.getElementById('rpeInput');
        const supersetInput = document.getElementById('supersetInput');
        const warmupCheck = document.getElementById('warmupCheck');
        const notizInput = document.getElementById('notizInput');
        const progressionHint = document.getElementById('progressionHint');
        const progressionText = document.getElementById('progressionText');
        const exerciseSearchInput = document.getElementById('exerciseSearchInput');

        // URL Basis f√ºr POST
        const addUrl = "{% url 'add_set' training.id %}";

        // Autocomplete initialisieren
        if (exerciseSearchInput) {
            const autocomplete = new ExerciseAutocomplete(exerciseSearchInput, allExercises, {
                minChars: 2,
                maxResults: 8,
                onSelect: (exercise) => {
                    // Muskelgruppe und √úbung automatisch ausw√§hlen
                    muscleFilter.value = exercise.muscleKey;
                    updateExerciseDropdown(exercise.muscleKey, exercise.id);
                    uebungSelect.value = exercise.id;

                    // Ghosting laden
                    loadGhosting(exercise.id);

                    // Suchfeld leeren
                    exerciseSearchInput.value = '';

                    // Focus auf Gewicht
                    setTimeout(() => gewichtInput.focus(), 100);
                }
            });
        }

        // Filter Logic
        muscleFilter.addEventListener('change', function() {
            updateExerciseDropdown(this.value);
        });

        function updateExerciseDropdown(muscleKey, preselectId = null) {
            uebungSelect.innerHTML = '<option value="" selected disabled>-- √úbung w√§hlen --</option>';
            if (!muscleKey) {
                uebungSelect.disabled = true; return;
            }
            const filtered = allExercises.filter(ex => ex.muscleKey === muscleKey);
            filtered.forEach(ex => {
                const opt = document.createElement('option');
                opt.value = ex.id; opt.text = ex.name;
                uebungSelect.appendChild(opt);
            });
            uebungSelect.disabled = false;

            if (preselectId) {
                uebungSelect.value = preselectId;
                // Nur Ghosting bei NEUEN S√§tzen (addUrl) triggern
                if(setForm.action === addUrl) fetchGhostData(preselectId);
            }
        }

        // Ghosting Trigger
        uebungSelect.addEventListener('change', function() {
            if(this.value && setForm.action.includes('add_set')) fetchGhostData(this.value);
        });

        // MODUS 1: NEUEN SATZ ERSTELLEN
        function openModalWithExercise(uebungId, lastSuperset = '0') {
            modalTitle.innerText = "Satz hinzuf√ºgen";
            setForm.action = addUrl;

            // Felder freischalten
            muscleFilter.disabled = false;

            // Reset
            gewichtInput.value = ""; wdhInput.value = ""; rpeInput.value = ""; warmupCheck.checked = false; notizInput.value = "";
            supersetInput.value = lastSuperset || '0'; // Letzte Superset-Gruppe oder 0
            progressionHint.style.display = 'none';

            if (uebungId) {
                const exData = allExercises.find(ex => ex.id === uebungId);
                if (exData) {
                    muscleFilter.value = exData.muscleKey;
                    updateExerciseDropdown(exData.muscleKey, uebungId);
                }
            } else {
                muscleFilter.value = "";
                updateExerciseDropdown(null);
            }
            myModal.show();
            setTimeout(() => { uebungId ? gewichtInput.focus() : muscleFilter.focus(); }, 500);
        }

        // MODUS 2: SATZ BEARBEITEN
        async function openEditModal(setId, uebungId, gewicht, wdh, rpe, isWarmup, notiz, supersetGroup) {
            modalTitle.innerText = "Satz bearbeiten";
            // URL dynamisch anpassen
            let updateUrl = "{% url 'update_set' 0 %}".replace('0', setId);
            setForm.action = updateUrl;

            // Werte f√ºllen
            const exData = allExercises.find(ex => ex.id === uebungId);
            if (exData) {
                muscleFilter.value = exData.muscleKey;
                updateExerciseDropdown(exData.muscleKey, uebungId);
            }

            // Felder sperren: √úbung darf beim Bearbeiten nicht ge√§ndert werden (Datenkonsistenz)
            muscleFilter.disabled = true;
            uebungSelect.disabled = true;

            // Pr√ºfe ob es Offline-Daten f√ºr diesen Satz gibt
            let finalGewicht = gewicht;
            let finalWdh = wdh;
            let finalRpe = rpe;
            let finalNotiz = notiz;
            let finalWarmup = isWarmup;
            let finalSuperset = supersetGroup;

            try {
                const offlineData = await offlineManager.getUnsyncedData('trainingData');
                console.log('[Edit Modal] Checking offline data for set ID:', setId, 'Total unsynced:', offlineData.length);

                // Suche nach ALLEN Updates f√ºr diesen Satz und nimm den NEUESTEN
                const matchingUpdates = offlineData.filter(item => {
                    return item.is_update && item.action && item.action.includes(`/set/${setId}/update/`);
                });

                console.log('[Edit Modal] Matching updates for this set:', matchingUpdates.length);

                if (matchingUpdates.length > 0) {
                    // Sortiere nach ID (Date.now() - h√∂here ID = neuerer Eintrag)
                    matchingUpdates.sort((a, b) => b.id - a.id);
                    const offlineUpdate = matchingUpdates[0];

                    console.log('[Edit Modal] Using latest offline update:', offlineUpdate);
                    finalGewicht = offlineUpdate.gewicht || gewicht;
                    finalWdh = offlineUpdate.wiederholungen || wdh;
                    finalRpe = offlineUpdate.rpe || rpe;
                    finalNotiz = offlineUpdate.notiz || notiz;
                    finalWarmup = offlineUpdate.is_warmup ? 'true' : 'false';
                    finalSuperset = offlineUpdate.superset_gruppe || supersetGroup;

                    // Zeige Hinweis
                    const hint = document.createElement('div');
                    hint.className = 'alert alert-warning alert-sm mb-2';
                    hint.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>Offline-√Ñnderungen werden angezeigt';
                    setForm.insertBefore(hint, setForm.firstChild);
                    setTimeout(() => hint.remove(), 3000);
                }
            } catch (e) {
                console.warn('[Edit Modal] Could not check offline data:', e);
            }

            // Daten eintragen (mit Komma-Fix f√ºr deutsche Zahlen)
            gewichtInput.value = String(finalGewicht).replace(',', '.');
            wdhInput.value = finalWdh;
            rpeInput.value = finalRpe;
            notizInput.value = finalNotiz || '';
            warmupCheck.checked = (finalWarmup === 'true');
            supersetInput.value = finalSuperset || '0';

            // Kein Progression Hint beim Bearbeiten
            progressionHint.style.display = 'none';

            myModal.show();
            setTimeout(() => gewichtInput.focus(), 500);
        }

        // API Call - holt Gewichtsempfehlung mit Planziel
        async function fetchGhostData(id) {
            try {
                // Planziel f√ºr diese √úbung ermitteln
                let zielParam = '';
                const planZiele = {{ plan_ziele|safe }};
                if (planZiele && planZiele[id] && planZiele[id].wiederholungen_ziel) {
                    zielParam = `?ziel=${planZiele[id].wiederholungen_ziel}`;
                }

                const res = await fetch(`/api/last-set/${id}/${zielParam}`);
                const data = await res.json();
                if (data.success) {
                    gewichtInput.value = data.gewicht;
                    wdhInput.value = data.wiederholungen;
                    if(data.rpe) rpeInput.value = data.rpe;

                    // Progressive Overload Hinweis anzeigen
                    if (data.progression_hint) {
                        progressionText.innerText = data.progression_hint;

                        // Vergleich mit letztem Mal anzeigen
                        if (data.letztes_gewicht !== data.gewicht || data.letzte_wdh !== data.wiederholungen) {
                            progressionText.innerText += ` (Letztes Mal: ${data.letztes_gewicht}kg √ó ${data.letzte_wdh})`;
                        }

                        progressionHint.style.display = 'block';
                    }
                }
            } catch (e) { console.error(e); }
        }

        // ========== UNDO DELETE SYSTEM ==========
        let deletedSets = []; // Array f√ºr gel√∂schte S√§tze mit Timeout

        // Delete Confirmation mit Undo
        function confirmDelete(setId, exerciseName, weight, reps) {
            const deleteUrl = `/set/${setId}/delete/`;

            // Satz-Daten f√ºr Undo speichern
            const setData = {
                setId: setId,
                exerciseName: exerciseName,
                weight: weight,
                reps: reps,
                deleteUrl: deleteUrl,
                timeout: null
            };

            // Sofort aus UI entfernen (optimistic delete)
            const setCard = document.querySelector(`[data-set-id="${setId}"]`);
            if (setCard) {
                setCard.style.opacity = '0.5';
                setCard.style.pointerEvents = 'none';
            }

            // Toast mit Undo-Button anzeigen
            showUndoToast(setData);

            // Nach 5 Sekunden endg√ºltig l√∂schen
            setData.timeout = setTimeout(() => {
                executeDelete(setData);
            }, 5000);

            deletedSets.push(setData);
        }

        function showUndoToast(setData) {
            // Toast mit Undo-Button erstellen
            const toastHtml = `
                <div class="toast-undo" data-set-id="${setData.setId}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <i class="bi bi-trash me-2"></i>
                            <strong>${setData.exerciseName}</strong> gel√∂scht
                            <small class="d-block text-muted">${setData.weight} kg √ó ${setData.reps} Wdh</small>
                        </div>
                        <button class="btn btn-sm btn-warning" onclick="undoDelete(${setData.setId})">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>R√ºckg√§ngig
                        </button>
                    </div>
                    <div class="progress mt-2" style="height: 2px;">
                        <div class="progress-bar bg-warning" style="width: 100%; animation: countdown 5s linear;"></div>
                    </div>
                </div>
            `;

            // Toast-Container (falls noch nicht vorhanden)
            let toastContainer = document.getElementById('undoToastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'undoToastContainer';
                toastContainer.style.cssText = 'position: fixed; bottom: 80px; right: 20px; z-index: 9999; max-width: 400px;';
                document.body.appendChild(toastContainer);
            }

            const toastDiv = document.createElement('div');
            toastDiv.innerHTML = toastHtml;
            toastContainer.appendChild(toastDiv.firstElementChild);

            // Auto-remove nach 5 Sekunden
            setTimeout(() => {
                const toastEl = toastContainer.querySelector(`[data-set-id="${setData.setId}"]`);
                if (toastEl) {
                    toastEl.style.opacity = '0';
                    toastEl.style.transition = 'opacity 0.3s';
                    setTimeout(() => toastEl.remove(), 300);
                }
            }, 5000);
        }

        function undoDelete(setId) {
            // Finde gel√∂schten Satz
            const index = deletedSets.findIndex(s => s.setId === setId);
            if (index === -1) return;

            const setData = deletedSets[index];

            // Timeout abbrechen
            clearTimeout(setData.timeout);

            // Aus Array entfernen
            deletedSets.splice(index, 1);

            // UI wiederherstellen
            const setCard = document.querySelector(`[data-set-id="${setId}"]`);
            if (setCard) {
                setCard.style.opacity = '1';
                setCard.style.pointerEvents = 'auto';
            }

            // Toast entfernen
            const toastEl = document.querySelector(`.toast-undo[data-set-id="${setId}"]`);
            if (toastEl) {
                toastEl.remove();
            }

            // Best√§tigungs-Toast
            if (typeof toast !== 'undefined') {
                toast.info('Satz wiederhergestellt');
            }
        }

        function executeDelete(setData) {
            // Endg√ºltiges L√∂schen via POST
            fetch(setData.deleteUrl, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    // Seite neu laden nach erfolgreichem Delete
                    location.reload();
                } else {
                    console.error('Delete fehlgeschlagen');
                    // Bei Fehler: Satz wiederherstellen
                    const setCard = document.querySelector(`[data-set-id="${setData.setId}"]`);
                    if (setCard) {
                        setCard.style.opacity = '1';
                        setCard.style.pointerEvents = 'auto';
                    }
                    if (typeof toast !== 'undefined') {
                        toast.error('Fehler beim L√∂schen');
                    }
                }
            })
            .catch(error => {
                console.error('Netzwerkfehler:', error);
                if (typeof toast !== 'undefined') {
                    toast.error('Netzwerkfehler beim L√∂schen');
                }
            });

            // Aus Array entfernen
            const index = deletedSets.findIndex(s => s.setId === setData.setId);
            if (index !== -1) {
                deletedSets.splice(index, 1);
            }
        }

        // ========== REST TIMER ==========
        let timerInterval = null;
        let timerSeconds = 90;
        let timerDuration = 90; // Standard-Dauer
        const restTimerEl = document.getElementById('restTimer');
        const timerDisplayEl = document.getElementById('timerDisplay');
        const timerSecondsEl = document.getElementById('timerSeconds');

        // Timer-Dauer und State beim Laden wiederherstellen
        window.addEventListener('load', function() {
            // Gespeicherte Timer-Dauer laden
            const savedDuration = localStorage.getItem('timerDuration');
            if (savedDuration) {
                timerDuration = parseInt(savedDuration);
                updateDropdownActive(timerDuration);
            }

            // Laufenden Timer wiederherstellen
            const savedTimer = localStorage.getItem('restTimer');
            if (savedTimer) {
                const data = JSON.parse(savedTimer);
                const elapsed = Math.floor((Date.now() - data.startTime) / 1000);
                const remaining = data.duration - elapsed;

                if (remaining > 0) {
                    startRestTimer(remaining);
                }
            }
        });

        // Sound-Settings (LocalStorage)
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false'; // Default: true
        let soundVolume = parseFloat(localStorage.getItem('soundVolume') || '0.3'); // Default: 30%

        function showPRToast(message) {
            const toastEl = document.getElementById('prToast');
            const toastBody = document.getElementById('prToastBody');
            toastBody.textContent = message;
            const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
            toast.show();
        }

        function toggleSound() {
            soundEnabled = document.getElementById('soundToggle').checked;
            localStorage.setItem('soundEnabled', soundEnabled);
        }

        // Deload-Toggle: Speichert Status per AJAX
        function toggleDeload(isDeload) {
            const banner = document.getElementById('deloadBanner');
            const hint = document.getElementById('deloadHint');

            if (isDeload) {
                banner.className = banner.className.replace('alert-dark', 'alert-info');
                hint.innerHTML = '<i class="bi bi-info-circle"></i> Wird nicht in Statistik gez√§hlt';
            } else {
                banner.className = banner.className.replace('alert-info', 'alert-dark');
                hint.innerHTML = 'Z√§hlt f√ºr Statistik';
            }

            fetch(`/api/training/{{ training.id }}/toggle-deload/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ ist_deload: isDeload })
            }).catch(err => console.warn('Deload-Toggle Fehler:', err));
        }

        function updateVolume(value) {
            soundVolume = value / 100; // 0-1 Range
            localStorage.setItem('soundVolume', soundVolume);
            document.getElementById('volumeValue').innerText = value;
        }

        // Settings beim Laden wiederherstellen
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('soundToggle').checked = soundEnabled;
            const volumePercent = Math.round(soundVolume * 100);
            document.getElementById('volumeSlider').value = volumePercent;
            document.getElementById('volumeValue').innerText = volumePercent;
        });

        function setTimerDuration(seconds) {
            timerDuration = seconds;
            localStorage.setItem('timerDuration', seconds);
            updateDropdownActive(seconds);
        }

        function updateDropdownActive(duration) {
            // Entferne alle active-Klassen
            document.querySelectorAll('.dropdown-menu .dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            // Setze active f√ºr gew√§hlte Dauer
            document.querySelectorAll('.dropdown-menu .dropdown-item').forEach(item => {
                const onclick = item.getAttribute('onclick');
                if (onclick && onclick.includes(`setTimerDuration(${duration})`)) {
                    item.classList.add('active');
                }
            });
        }

        // Sound f√ºr Timer-Ende (Web Audio API)
        function playTimerSound() {
            if (!soundEnabled) return; // Sound deaktiviert

            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Drei Beeps: hoch-mittel-hoch
                const beeps = [
                    { freq: 800, start: 0, duration: 0.15 },
                    { freq: 600, start: 0.2, duration: 0.15 },
                    { freq: 800, start: 0.4, duration: 0.3 }
                ];

                beeps.forEach(beep => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = beep.freq;
                    oscillator.type = 'sine';

                    gainNode.gain.setValueAtTime(soundVolume, audioContext.currentTime + beep.start);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + beep.start + beep.duration);

                    oscillator.start(audioContext.currentTime + beep.start);
                    oscillator.stop(audioContext.currentTime + beep.start + beep.duration);
                });
            } catch (e) {
                console.log('Audio nicht verf√ºgbar:', e);
            }
        }

        function startRestTimer(seconds = null) {
            stopTimer(); // Stop any existing timer
            timerSeconds = seconds !== null ? seconds : timerDuration;
            timerSecondsEl.innerText = timerSeconds;
            restTimerEl.style.display = 'block';
            timerDisplayEl.classList.add('timer-running');

            // Timer-State in localStorage speichern
            localStorage.setItem('restTimer', JSON.stringify({
                startTime: Date.now(),
                duration: timerSeconds
            }));

            timerInterval = setInterval(() => {
                timerSeconds--;
                timerSecondsEl.innerText = timerSeconds;

                // Farbwechsel bei wenig Zeit
                if (timerSeconds <= 10) {
                    timerDisplayEl.classList.remove('bg-warning');
                    timerDisplayEl.classList.add('bg-danger', 'text-white');
                }

                // Countdown-Beeps bei letzten 3 Sekunden
                if (soundEnabled && timerSeconds > 0 && timerSeconds <= 3) {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.frequency.value = 600;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(soundVolume, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.1);
                    } catch (e) {}
                }

                // Timer abgelaufen
                if (timerSeconds <= 0) {
                    stopTimer();

                    // Sound abspielen
                    playTimerSound();

                    // Vibration (wenn verf√ºgbar)
                    if (navigator.vibrate) {
                        navigator.vibrate([200, 100, 200, 100, 200]);
                    }

                    // Notification zeigen (ohne alert - nicht-blockierend)
                    const notification = document.createElement('div');
                    notification.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #198754; color: white; padding: 2rem; border-radius: 1rem; font-size: 1.5rem; z-index: 10000; box-shadow: 0 0 20px rgba(0,0,0,0.5); text-align: center;';
                    notification.innerHTML = '‚è∞<br><strong>Pause vorbei!</strong><br><small>Bereit f√ºr den n√§chsten Satz?</small>';
                    document.body.appendChild(notification);

                    // Auto-remove nach 3 Sekunden
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        notification.style.transition = 'opacity 0.5s';
                        setTimeout(() => notification.remove(), 500);
                    }, 3000);
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            localStorage.removeItem('restTimer');
            restTimerEl.style.display = 'none';
            timerDisplayEl.classList.remove('timer-running', 'bg-danger', 'text-white');
            timerDisplayEl.classList.add('bg-warning', 'text-dark');
        }

        // Helper: CSRF Token aus Cookie holen
        function getCSRFToken() {
            const name = 'csrftoken';
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    return cookie.substring(name.length + 1);
                }
            }
            return '';
        }

        // AJAX Form Submit (verhindert Page Reload & beh√§lt Stoppuhr)
        setForm.addEventListener('submit', async function(e) {
            e.preventDefault(); // Verhindere normalen Form Submit

            // Emoji-Filter: Entferne 4-Byte-Emojis (tempor√§r bis utf8mb4-Migration deployed ist)
            const notizField = document.getElementById('notizInput');
            if (notizField && notizField.value) {
                const originalValue = notizField.value;
                // Entferne alle 4-Byte UTF-8 Zeichen (Emojis)
                const cleanedValue = originalValue.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');

                if (originalValue !== cleanedValue) {
                    notizField.value = cleanedValue;
                    showToast('‚ÑπÔ∏è Emojis wurden entfernt (noch nicht unterst√ºtzt)', 'warning', 3000);
                }
            }

            const formData = new FormData(setForm);
            const submitBtn = setForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Speichern...';

            // Versuche ZUERST Online-Submit
            try {
                // Timeout mit AbortController (Browser-kompatibel)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(setForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCSRFToken()
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId); // Wichtig: Timer clearen bei Erfolg

                // Pr√ºfe Response Status BEVOR du parsest
                if (!response.ok) {
                    // Server-Fehler (4xx, 5xx) - NICHT offline!
                    let errorMsg = 'Serverfehler beim Speichern';

                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const data = await response.json();
                            errorMsg = data.error || errorMsg;
                        }
                    } catch (parseError) {
                        // HTML-Fehlerseite statt JSON - typisch f√ºr 500er Fehler
                        console.error('[Server Error] Status:', response.status, response.statusText);
                        errorMsg = `Serverfehler (${response.status}). Bitte versuche es erneut oder kontaktiere Support.`;
                    }

                    showToast(errorMsg, 'error', 5000);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Speichern';
                    return; // Wichtig: NICHT in den Offline-Modus gehen!
                }

                // Response OK - parse JSON
                const data = await response.json();

                // Pr√ºfe ob Service Worker Offline-Response zur√ºckgegeben hat
                if (data.offline) {
                    console.log('[Offline] Service Worker returned offline response, saving locally...');
                    // Behandle wie im catch-Block (speichere in IndexedDB)
                    throw new Error('Offline mode - saving locally');
                }

                if (data.success) {
                    // PR-Toast anzeigen falls vorhanden
                    if (data.pr_message) {
                        showPRToast(data.pr_message);
                    }

                    myModal.hide();

                    // Seite neu laden um S√§tze anzuzeigen (aber ohne die Stoppuhr zu stoppen)
                    location.reload();
                } else {
                    showToast(data.error || 'Satz konnte nicht gespeichert werden', 'error', 4000);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Speichern';
                }
            } catch (error) {
                // Pr√ºfe ob es ein ECHTER Netzwerkfehler ist (offline) oder ein Parse/Timeout-Fehler
                const isNetworkError = error.name === 'TypeError' ||
                                      error.message.includes('Failed to fetch') ||
                                      error.message.includes('NetworkError') ||
                                      error.message.includes('Offline mode');

                const isTimeout = error.name === 'TimeoutError' || error.name === 'AbortError';

                if (!isNetworkError && !isTimeout) {
                    // Unerwarteter Fehler (z.B. Parse-Error) - zeige Fehler, gehe NICHT offline
                    console.error('[Submit Error]', error);
                    showToast('Fehler beim Speichern: ' + error.message, 'error', 5000);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Speichern';
                    return;
                }

                // Echter Offline-Modus oder Timeout ‚Üí Speichere lokal
                console.log('[Offline] Server nicht erreichbar, speichere lokal:', error.message);

                try {
                    // Offline: Speichere in IndexedDB
                    // WICHTIG: Bei Update ist das Select disabled ‚Üí Wert direkt aus Select holen
                    const uebungId = formData.get('uebung') || uebungSelect.value;
                    const uebungName = allExercises.find(ex => ex.id == uebungId)?.name || '√úbung';

                    console.log('[Offline] uebungId:', uebungId, 'uebungName:', uebungName);

                    // Pr√ºfe ob es ein Update ist (URL enth√§lt /set/X/update/)
                    const isUpdate = setForm.action.includes('/set/') && setForm.action.includes('/update/');

                    const setData = {
                        id: Date.now(),
                        training_id: {{ training.id }},
                        uebung_id: parseInt(uebungId),
                        uebung_name: uebungName,
                        gewicht: formData.get('gewicht'),
                        wiederholungen: formData.get('wiederholungen'),
                        rpe: formData.get('rpe') || null,
                        is_warmup: formData.get('warmup') === 'on',
                        superset_gruppe: formData.get('superset_gruppe') || 0,
                        notiz: formData.get('notiz') || '',
                        timestamp: new Date().toISOString(),
                        synced: false,
                        action: setForm.action,
                        is_update: isUpdate
                    };

                    console.log('[Offline] Saving setData:', setData);
                    await offlineManager.saveOfflineData('trainingData', setData);
                    console.log('[Offline] Save successful');

                    // Toast anzeigen
                    const toast = document.createElement('div');
                    toast.className = 'connection-toast offline';
                    toast.innerHTML = isUpdate ?
                        'üíæ √Ñnderung offline gespeichert - wird synchronisiert' :
                        'üíæ Satz offline gespeichert - wird synchronisiert';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);

                    myModal.hide();
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Speichern';

                    // Bei Update: Satz in UI aktualisieren + gelben Badge hinzuf√ºgen
                    // Bei Add: Satz sofort in UI anzeigen (addOfflineSetToUI ruft updateOfflineBanner auf)
                    if (isUpdate) {
                        console.log('[Offline] Update saved offline');

                        // Extrahiere Set-ID aus URL (z.B. /set/359/update/)
                        const setIdMatch = setForm.action.match(/\/set\/(\d+)\/update\//);
                        if (setIdMatch) {
                            const setId = setIdMatch[1];
                            console.log('[Offline] Updating set in UI, ID:', setId);

                            // Finde den Edit-Button mit dieser Set-ID
                            const editBtn = document.querySelector(`button[onclick*="openEditModal('${setId}'"]`);
                            console.log('[Offline] Edit button found:', !!editBtn);

                            if (editBtn) {
                                const row = editBtn.closest('tr');
                                console.log('[Offline] Row found:', !!row);

                                if (row && row.cells && row.cells.length >= 3) {
                                    // Aktualisiere Gewicht (Zelle 1 - nach der #-Spalte)
                                    const gewichtCell = row.cells[1];
                                    const gewichtSpan = gewichtCell.querySelector('.fw-bold');
                                    console.log('[Offline] Gewicht span found:', !!gewichtSpan);

                                    if (gewichtSpan) {
                                        gewichtSpan.textContent = setData.gewicht;
                                    }

                                    // Aktualisiere Wiederholungen (Zelle 2)
                                    const wdhCell = row.cells[2];
                                    const wdhSpan = wdhCell.querySelector('.fw-bold');
                                    console.log('[Offline] Wdh span found:', !!wdhSpan);

                                    if (wdhSpan) {
                                        wdhSpan.textContent = setData.wiederholungen;
                                    }

                                    // F√ºge gelben Hintergrund hinzu
                                    row.classList.add('bg-warning', 'bg-opacity-10');

                                    // F√ºge Offline-Badge hinzu
                                    if (!row.querySelector('.badge.bg-warning')) {
                                        const badge = document.createElement('span');
                                        badge.className = 'badge bg-warning ms-2';
                                        badge.innerHTML = '<i class="bi bi-cloud-upload me-1"></i>Offline';
                                        gewichtCell.appendChild(badge);
                                    }

                                    console.log('[Offline] UI updated successfully');
                                } else {
                                    console.warn('[Offline] Row or cells not found');
                                }
                            } else {
                                console.warn('[Offline] Edit button not found for set ID:', setId);
                            }
                        } else {
                            console.warn('[Offline] Could not extract set ID from URL:', setForm.action);
                        }

                        // Zeige zus√§tzlichen Hinweis
                        const infoToast = document.createElement('div');
                        infoToast.className = 'connection-toast offline';
                        infoToast.style.top = '80px'; // Unter dem ersten Toast
                        infoToast.innerHTML = '‚úì UI aktualisiert - wird beim Sync √ºbertragen';
                        document.body.appendChild(infoToast);
                        setTimeout(() => infoToast.remove(), 4000);
                    } else {
                        console.log('[Offline] Adding to UI...');
                        addOfflineSetToUI(setData);
                    }

                    // Registriere Background Sync
                    if ('serviceWorker' in navigator && 'sync' in navigator.serviceWorker) {
                        navigator.serviceWorker.ready.then(registration => {
                            console.log('[Offline] Registering background sync...');
                            return registration.sync.register('sync-training-data');
                        }).catch(err => console.error('Sync registration failed:', err));
                    }
                } catch (offlineError) {
                    console.error('[Offline] Fehler beim Offline-Speichern:', offlineError);
                    showToast('Offline-Speicherung fehlgeschlagen. Bitte sp√§ter erneut versuchen.', 'error', 5000);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Speichern';
                }
            }
        });
    </script>

    <!-- Include Exercise Info Modal -->
    {% include 'core/exercise_info_modal.html' %}

    <!-- Include AI Coach Chat -->
    {% include 'core/ai_coach_chat.html' %}

    <!-- Toast Notification System -->
    <script src="{% static 'core/js/toast.js' %}"></script>

    <!-- Keyboard Shortcuts -->
    <script src="{% static 'core/js/keyboard-shortcuts.js' %}"></script>

    <script>

    // Funktion um offline Satz in UI hinzuzuf√ºgen

        function addOfflineSetToUI(setData) {
            // Finde oder erstelle √úbungs-Container
            const uebungName = setData.uebung_name || '√úbung';
            const mainContent = document.querySelector('.container > .row');

            if (!mainContent) {
                console.error('[Offline] Could not find main content area');
                return;
            }

            // Suche existierende √úbungskarte
            let exerciseCard = null;
            const allCards = mainContent.querySelectorAll('.card');

            for (const card of allCards) {
                const cardTitle = card.querySelector('.card-title, h5');
                if (cardTitle && cardTitle.textContent.includes(uebungName)) {
                    exerciseCard = card;
                    break;
                }
            }

            // Wenn √úbung noch nicht existiert, erstelle neue Karte
            if (!exerciseCard) {
                const col = document.createElement('div');
                col.className = 'col-12';
                col.innerHTML = `
                    <div class="card card-stat mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${uebungName}</h5>
                                <button class="btn btn-sm btn-primary" onclick="openModalWithExercise('${setData.uebung_id}', '${setData.superset_gruppe}')">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                            <div class="set-list"></div>
                        </div>
                    </div>
                `;
                mainContent.insertBefore(col, mainContent.firstChild);
                exerciseCard = col.querySelector('.card');
            }

            // F√ºge Satz zur Liste hinzu
            const setList = exerciseCard.querySelector('.set-list');
            const setDiv = document.createElement('div');
            setDiv.className = 'set-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded bg-warning bg-opacity-10';
            setDiv.innerHTML = `
                <div>
                    <i class="bi bi-cloud-upload text-warning me-2"></i>
                    <strong>#${setList.children.length + 1}</strong>
                    <span class="ms-2">${setData.gewicht} kg √ó ${setData.wiederholungen} Wdh</span>
                    ${setData.rpe ? `<span class="badge bg-secondary ms-2">RPE ${setData.rpe}</span>` : ''}
                    ${setData.is_warmup ? '<span class="badge bg-info ms-2">Warm-up</span>' : ''}
                    ${setData.notiz ? `<br><small class="text-muted">${setData.notiz}</small>` : ''}
                </div>
                <div>
                    <span class="badge bg-warning">Offline</span>
                </div>
            `;
            setList.appendChild(setDiv);

            // Update oder erstelle Banner
            updateOfflineBanner();
        }

        // Funktion um Offline-Banner zu aktualisieren
        function updateOfflineBanner() {
            offlineManager.getAllData('trainingData').then(allData => {
                const trainingId = {{ training.id }};
                const offlineSets = allData.filter(item =>
                    item.training_id === trainingId && !item.synced
                );

                let banner = document.getElementById('offline-banner');

                if (offlineSets.length > 0) {
                    if (!banner) {
                        banner = document.createElement('div');
                        banner.id = 'offline-banner';
                        banner.className = 'alert alert-warning d-flex align-items-center mb-3';

                        const container = document.querySelector('.container');
                        if (container) {
                            container.insertBefore(banner, container.firstChild);
                        }
                    }

                    banner.innerHTML = `
                        <i class="bi bi-cloud-upload me-2"></i>
                        <div>
                            <strong>${offlineSets.length} Satz${offlineSets.length > 1 ? 'e' : ''} offline gespeichert</strong>
                            <br><small>Werden automatisch synchronisiert wenn du wieder online bist</small>
                        </div>
                    `;
                } else if (banner) {
                    banner.remove();
                }
            });
        }

        // Offline S√§tze beim Laden anzeigen
        async function loadOfflineSets() {
            try {
                updateOfflineBanner();
            } catch (error) {
                console.error('[Offline] Error loading offline sets:', error);
            }
        }

        // Quick Tags f√ºr Notizen
        function insertTag(tag) {
            const notizInput = document.getElementById('notizInput');
            const currentValue = notizInput.value.trim();

            if (currentValue) {
                notizInput.value = currentValue + ' | ' + tag;
            } else {
                notizInput.value = tag;
            }

            updateCharCount();
            notizInput.focus();
        }

        function clearNotiz() {
            document.getElementById('notizInput').value = '';
            updateCharCount();
        }

        function updateCharCount() {
            const notizInput = document.getElementById('notizInput');
            const charCount = document.getElementById('charCount');
            const length = notizInput.value.length;

            charCount.textContent = `${length} / 500 Zeichen`;

            if (length > 450) {
                charCount.classList.add('text-warning');
                charCount.classList.remove('text-muted');
            } else if (length === 500) {
                charCount.classList.add('text-danger');
                charCount.classList.remove('text-warning', 'text-muted');
            } else {
                charCount.classList.add('text-muted');
                charCount.classList.remove('text-warning', 'text-danger');
            }
        }

        // Nach DOMContentLoaded laden
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadOfflineSets();
                updateCharCount();
            });
        } else {
            loadOfflineSets();
            updateCharCount();
        }
    </script>

{% endblock extra_scripts %}
