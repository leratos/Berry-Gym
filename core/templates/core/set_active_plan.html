{% extends 'base.html' %}
{% load i18n static %}

{% block title %}{% trans "Aktiven Plan setzen" %}{% endblock %}

{% block extra_head %}
<style>
  .plan-group-option {
    cursor: pointer;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .plan-group-option:hover { border-color: var(--bs-primary) !important; }
  .plan-group-option.selected {
    border-color: var(--bs-primary) !important;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }
  .plan-group-option input[type="radio"] { display: none; }
</style>
{% endblock %}

{% block page_nav %}
<nav class="navbar navbar-page border-bottom">
  <div class="container-fluid">
    <a class="btn btn-outline-secondary border-0" href="{% url 'dashboard' %}">
        <i class="bi bi-arrow-left"></i> {% trans "Zurück" %}
    </a>
    <span class="navbar-text page-title fw-bold">{% trans "Aktiver Plan" %}</span>
    <div style="width: 40px;">
        <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary border-0 ms-2" title="{% trans "Theme wechseln" %}">
          <i class="bi bi-moon-fill" id="themeIcon"></i>
        </button>
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="container pt-3">
  <h5 class="mb-3">
    <i class="bi bi-bullseye text-primary me-2"></i>{% trans "Aktiven Trainingsplan festlegen" %}
  </h5>

  {% if current_active %}
  <div class="alert alert-info d-flex align-items-center">
    <i class="bi bi-info-circle-fill me-2"></i>
    <span><strong>{% trans "Aktuell aktiv:" %}</strong> {% for g in plan_gruppen %}{% if g.gruppe_id|stringformat:"s" == current_active %}{{ g.name }}{% endif %}{% endfor %}</span>
  </div>
  {% endif %}

  <form method="post">
    {% csrf_token %}

    {% if plan_gruppen %}
    <div class="d-grid gap-3 mb-4">
      <label class="card card-stat plan-group-option {% if not current_active %}selected border-warning{% else %}border-secondary{% endif %}" id="option-none">
        <div class="card-body d-flex align-items-center p-3">
          <input type="radio" name="gruppe_id" value="" {% if not current_active %}checked{% endif %} onchange="selectOption('none')">
          <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3 text-warning">
            <i class="bi bi-x-circle fs-4"></i>
          </div>
          <div>
            <h6 class="mb-0">{% trans "Kein aktiver Plan" %}</h6>
            <small class="text-muted">{% trans "Alle Pläne werden gleichwertig angezeigt" %}</small>
          </div>
        </div>
      </label>

      {% for gruppe in plan_gruppen %}
      <label class="card card-stat plan-group-option {% if gruppe.gruppe_id|stringformat:"s" == current_active %}selected border-primary{% else %}border-secondary{% endif %}" id="option-{{ gruppe.gruppe_id }}">
        <div class="card-body d-flex align-items-center p-3">
          <input type="radio" name="gruppe_id" value="{{ gruppe.gruppe_id }}" {% if gruppe.gruppe_id|stringformat:"s" == current_active %}checked{% endif %} onchange="selectOption('{{ gruppe.gruppe_id }}')">
          <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3 text-primary">
            <i class="bi bi-collection-fill fs-4"></i>
          </div>
          <div class="flex-grow-1">
            <h6 class="mb-0">{{ gruppe.name }}</h6>
            <small class="text-muted">{% blocktrans with count=gruppe.plan_count %}{{ count }} Trainingstage{% endblocktrans %}</small>
          </div>
          {% if gruppe.gruppe_id|stringformat:"s" == current_active %}
          <span class="badge bg-primary ms-2">{% trans "Aktiv" %}</span>
          {% endif %}
        </div>
      </label>
      {% endfor %}
    </div>

    <div class="card card-stat border-secondary mb-4">
      <div class="card-body p-3">
        <h6 class="mb-2"><i class="bi bi-calendar-week me-2"></i>{% trans "Mesozyklus-Länge" %}</h6>
        <div class="d-flex align-items-center gap-3">
          <select name="cycle_length" class="form-select" style="max-width: 200px;">
            {% for i in "23456789" %}
            <option value="{{ i }}" {% if current_cycle_length|stringformat:"s" == i %}selected{% endif %}>
              {% blocktrans with w=i dw=i|add:"-1" %}{{ w }} Wochen ({{ dw }} + 1 Deload){% endblocktrans %}
            </option>
            {% endfor %}
          </select>
          <small class="text-muted">{% trans "Letzte Woche = Deload" %}</small>
        </div>
      </div>
    </div>

    <div class="card card-stat border-secondary mb-4">
      <div class="card-body p-3">
        <h6 class="mb-2"><i class="bi bi-skip-forward me-2"></i>{% trans "Laufende Woche" %} <span class="badge bg-secondary ms-1">{% trans "optional" %}</span></h6>
        <small class="text-muted d-block mb-2">
          {% trans "Falls du mitten in einem Zyklus auf diesen Plan wechselst, gib hier deine aktuelle Woche an. Leer lassen = Zyklus startet ab heute bei Woche 1." %}
        </small>
        <div class="d-flex align-items-center gap-3">
          <input type="number" name="current_week" class="form-control" style="max-width: 100px;"
                 min="1" max="12" placeholder="{% trans "z.B. 3" %}">
          <small class="text-muted">{% blocktrans with n=current_cycle_length %}Woche 1 – {{ n }}{% endblocktrans %}</small>
        </div>
      </div>
    </div>

    <div class="card card-stat border-secondary mb-4">
      <div class="card-body p-3">
        <h6 class="mb-2"><i class="bi bi-battery-half me-2"></i>{% trans "Deload-Einstellungen" %}</h6>
        <small class="text-muted d-block mb-3">{% trans "Werden automatisch in der Deload-Woche angewendet. KI-Pläne setzen diese Werte automatisch." %}</small>
        <div class="row g-3">
          <div class="col-4">
            <label class="form-label small">{% trans "Volumen" %}</label>
            <select name="deload_volume_factor" class="form-select form-select-sm">
              <option value="0.6" {% if deload_volume_factor == 0.6 %}selected{% endif %}>-40%</option>
              <option value="0.7" {% if deload_volume_factor == 0.7 %}selected{% endif %}>-30%</option>
              <option value="0.8" {% if deload_volume_factor == 0.8 %}selected{% endif %}>-20%</option>
              <option value="0.9" {% if deload_volume_factor == 0.9 %}selected{% endif %}>-10%</option>
            </select>
          </div>
          <div class="col-4">
            <label class="form-label small">{% trans "Gewicht" %}</label>
            <select name="deload_weight_factor" class="form-select form-select-sm">
              <option value="0.8" {% if deload_weight_factor == 0.8 %}selected{% endif %}>-20%</option>
              <option value="0.85" {% if deload_weight_factor == 0.85 %}selected{% endif %}>-15%</option>
              <option value="0.9" {% if deload_weight_factor == 0.9 %}selected{% endif %}>-10%</option>
              <option value="0.95" {% if deload_weight_factor == 0.95 %}selected{% endif %}>-5%</option>
            </select>
          </div>
          <div class="col-4">
            <label class="form-label small">{% trans "Ziel-RPE" %}</label>
            <select name="deload_rpe_target" class="form-select form-select-sm">
              <option value="6.0" {% if deload_rpe_target == 6.0 %}selected{% endif %}>6.0</option>
              <option value="6.5" {% if deload_rpe_target == 6.5 %}selected{% endif %}>6.5</option>
              <option value="7.0" {% if deload_rpe_target == 7.0 %}selected{% endif %}>7.0</option>
              <option value="7.5" {% if deload_rpe_target == 7.5 %}selected{% endif %}>7.5</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="d-grid gap-2">
      <button type="submit" class="btn btn-primary btn-lg">
        <i class="bi bi-check-lg me-2"></i>{% trans "Plan aktivieren" %}
      </button>
      <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
        <i class="bi bi-x-lg me-2"></i>{% trans "Abbrechen" %}
      </a>
    </div>

    {% else %}
    <div class="alert alert-warning">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      <strong>{% trans "Keine Plan-Gruppen gefunden!" %}</strong><br>
      {% trans "Erstelle zuerst Trainingspläne und gruppiere sie, um diese Funktion zu nutzen." %}
    </div>
    <a href="{% url 'training_select_plan' %}" class="btn btn-primary">
      <i class="bi bi-plus-circle me-2"></i>{% trans "Pläne verwalten" %}
    </a>
    {% endif %}
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  function selectOption(id) {
    document.querySelectorAll('.plan-group-option').forEach(el => {
      el.classList.remove('selected', 'border-primary', 'border-warning');
      el.classList.add('border-secondary');
    });
    const option = document.getElementById('option-' + id);
    if (option) {
      option.classList.remove('border-secondary');
      option.classList.add('selected');
      option.classList.add(id === 'none' ? 'border-warning' : 'border-primary');
    }
  }
</script>
{% endblock %}
