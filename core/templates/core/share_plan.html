{% extends 'base.html' %}
{% load static %}

{% block title %}Plan teilen: {{ plan.name }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'core/css/toast.css' %}">
{% endblock %}

{% block page_nav %}
<nav class="navbar navbar-page border-bottom">
  <div class="container-fluid">
    <a class="btn btn-outline-secondary border-0" href="{% url 'plan_details' plan.id %}">
        <i class="bi bi-arrow-left"></i> Zurück
    </a>
    <span class="navbar-text page-title fw-bold">Plan teilen</span>
    <div style="width: 40px;">
        <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary border-0" title="Theme wechseln">
            <i class="bi bi-moon-fill" id="themeIcon"></i>
        </button>
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="container pt-4">
    <div class="card card-stat mb-4">
        <div class="card-body text-center">
            <h3 class="mb-1">{{ plan.name }}</h3>
            {% if plan.beschreibung %}
            <p class="text-muted mb-3">{{ plan.beschreibung|truncatechars:100 }}</p>
            {% endif %}
            <div class="d-flex justify-content-center mb-3 gap-2">
                <span class="badge bg-secondary">{{ plan.uebungen.count }} Übungen</span>
                {% if plan.is_public %}
                <span class="badge bg-success"><i class="bi bi-globe"></i> Öffentlich</span>
                {% else %}
                <span class="badge bg-warning text-dark"><i class="bi bi-lock-fill"></i> Privat</span>
                {% endif %}
            </div>
            {% if is_owner and not plan.is_public %}
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Achtung:</strong> Dieser Plan ist privat. Andere können den Link nicht öffnen.
                <a href="{% url 'toggle_plan_public' plan.id %}" class="btn btn-sm btn-success ms-2">
                    <i class="bi bi-globe me-1"></i>Öffentlich machen
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card card-stat mb-4">
        <div class="card-body text-center">
            <h5 class="mb-3"><i class="bi bi-qr-code me-2"></i>QR-Code</h5>
            {% if qr_base64 %}
            <div class="bg-white d-inline-block p-3 rounded mb-3">
                <img src="data:image/png;base64,{{ qr_base64 }}" alt="QR-Code" class="img-fluid" style="max-width: 200px;">
            </div>
            <p class="text-muted small">Scanne diesen Code, um den Plan zu öffnen</p>
            {% else %}
            <div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>QR-Code Generator nicht verfügbar.</div>
            {% endif %}
        </div>
    </div>

    <div class="card card-stat mb-4">
        <div class="card-body">
            <h5 class="mb-3"><i class="bi bi-link-45deg me-2"></i>Direkter Link</h5>
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="share-url" value="{{ share_url }}" readonly>
                <button class="btn btn-primary" onclick="copyToClipboard()">
                    <i class="bi bi-clipboard"></i> Kopieren
                </button>
            </div>
            <div id="copy-success" class="alert alert-success d-none">
                <i class="bi bi-check-circle me-2"></i>Link in die Zwischenablage kopiert!
            </div>
        </div>
    </div>

    {% if is_owner %}
    <div class="card card-stat border-primary mb-4">
        <div class="card-body">
            <h5 class="mb-3"><i class="bi bi-people-fill me-2 text-primary"></i>Mit Trainingspartner teilen</h5>
            <p class="text-muted small mb-3">Teile diesen Plan privat mit deinem Trainingspartner.</p>
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="partner-search" placeholder="Username eingeben..." autocomplete="off">
                <button class="btn btn-primary" onclick="searchAndSharePartner()" id="share-btn">
                    <i class="bi bi-person-plus"></i> Einladen
                </button>
            </div>
            <div id="search-results" class="list-group mb-3 d-none"></div>
            <div id="shared-with-container">
                <h6 class="text-muted mb-2"><i class="bi bi-check2-circle me-1"></i>Bereits geteilt mit:</h6>
                <div id="shared-with-list" class="d-flex flex-wrap gap-2">
                    <span class="text-muted small">Lade...</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card card-stat mb-4">
        <div class="card-body">
            <h5 class="mb-3"><i class="bi bi-share me-2"></i>Teilen via</h5>
            <div class="d-grid gap-2">
                <a href="https://api.whatsapp.com/send?text=Check%20dir%20meinen%20Trainingsplan%3A%20{{ share_url|urlencode }}"
                   target="_blank" class="btn btn-success"><i class="bi bi-whatsapp me-2"></i>WhatsApp</a>
                <a href="https://t.me/share/url?url={{ share_url|urlencode }}&text=Check%20dir%20meinen%20Trainingsplan!"
                   target="_blank" class="btn btn-info"><i class="bi bi-telegram me-2"></i>Telegram</a>
                <a href="mailto:?subject=Mein%20Trainingsplan&body=Hey!%0A%0ACheck%20dir%20meinen%20Trainingsplan%3A%0A{{ share_url|urlencode }}"
                   class="btn btn-secondary"><i class="bi bi-envelope me-2"></i>E-Mail</a>
            </div>
        </div>
    </div>

    {% if is_owner %}
    <div class="d-grid gap-2 mb-4">
        <a href="{% url 'duplicate_plan' plan.id %}" class="btn btn-outline-primary">
            <i class="bi bi-copy me-2"></i>Plan duplizieren
        </a>
        <a href="{% url 'toggle_plan_public' plan.id %}" class="btn btn-outline-{% if plan.is_public %}warning{% else %}success{% endif %}">
            {% if plan.is_public %}<i class="bi bi-lock-fill me-2"></i>Privat machen
            {% else %}<i class="bi bi-globe me-2"></i>Öffentlich machen{% endif %}
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const planId = {{ plan.id }};
    let searchTimeout = null;

    function copyToClipboard() {
        const urlInput = document.getElementById('share-url');
        urlInput.select();
        navigator.clipboard.writeText(urlInput.value);
        const el = document.getElementById('copy-success');
        el.classList.remove('d-none');
        setTimeout(() => el.classList.add('d-none'), 3000);
    }

    function loadSharedWith() {
        fetch(`{% url 'api_get_plan_shares' plan.id %}`)
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('shared-with-list');
                container.innerHTML = (data.shared_with && data.shared_with.length > 0)
                    ? data.shared_with.map(u => `<span class="badge bg-primary d-flex align-items-center gap-1"><i class="bi bi-person"></i> ${u.username}<button class="btn-close btn-close-white ms-1" style="font-size:0.6rem;" onclick="removeShare(${u.id},'${u.username}')"></button></span>`).join('')
                    : '<span class="text-muted small">Noch mit niemandem geteilt</span>';
            })
            .catch(() => { document.getElementById('shared-with-list').innerHTML = '<span class="text-danger small">Fehler beim Laden</span>'; });
    }

    document.getElementById('partner-search')?.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        const resultsDiv = document.getElementById('search-results');
        if (query.length < 2) { resultsDiv.classList.add('d-none'); return; }
        searchTimeout = setTimeout(() => {
            fetch(`{% url 'api_search_users' %}?q=${encodeURIComponent(query)}`)
                .then(r => r.json())
                .then(data => {
                    resultsDiv.innerHTML = (data.users && data.users.length > 0)
                        ? data.users.map(u => `<button type="button" class="list-group-item list-group-item-action" onclick="shareWithUser('${u.username}')"><i class="bi bi-person me-2"></i>${u.username}</button>`).join('')
                        : '<div class="list-group-item text-muted">Kein User gefunden</div>';
                    resultsDiv.classList.remove('d-none');
                });
        }, 300);
    });

    function shareWithUser(username) {
        document.getElementById('partner-search').value = username;
        document.getElementById('search-results').classList.add('d-none');
        searchAndSharePartner();
    }

    function searchAndSharePartner() {
        const username = document.getElementById('partner-search').value.trim();
        if (!username) { toast.warning('Bitte einen Username eingeben'); return; }
        fetch('{% url "api_share_plan_with_user" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ plan_id: planId, username })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) { document.getElementById('partner-search').value = ''; document.getElementById('search-results').classList.add('d-none'); loadSharedWith(); toast.success('Plan erfolgreich geteilt!'); }
            else { toast.error(data.error || 'Fehler beim Teilen'); }
        })
        .catch(() => toast.error('Ein Fehler ist aufgetreten'));
    }

    function removeShare(userId, username) {
        if (!confirm(`Freigabe für "${username}" entfernen?`)) return;
        fetch('{% url "api_unshare_plan_with_user" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ plan_id: planId, user_id: userId })
        })
        .then(r => r.json())
        .then(data => { if (data.success) { loadSharedWith(); toast.success('Freigabe entfernt'); } else { toast.error(data.error || 'Fehler'); } });
    }

    {% if is_owner %}
    document.addEventListener('DOMContentLoaded', loadSharedWith);
    {% endif %}
</script>
<script src="{% static 'core/js/toast.js' %}"></script>
{% endblock %}
