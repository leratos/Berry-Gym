{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Körperwert bearbeiten" %}{% endblock %}

{% block page_nav %}
<nav class="navbar navbar-page border-bottom mb-4">
  <div class="container-fluid">
    <a class="btn btn-outline-secondary border-0" href="{% url 'body_stats' %}">
        <i class="bi bi-x-lg"></i>
    </a>
    <span class="navbar-text page-title fw-bold">{% trans "Körperwert bearbeiten" %}</span>
    <div style="width: 40px;"></div>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="container">
  <form method="post">
    {% csrf_token %}

    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>{% trans "Datum" %}:</strong> {{ wert.datum|date:"d.m.Y" }}
    </div>

    <div class="mb-3">
        <label class="form-label text-muted small">{% trans "Größe (cm)" %}</label>
        <input type="number" name="groesse_cm" value="{{ wert.groesse_cm|default:'' }}"
               class="form-control bg-dark text-white border-secondary"
               min="100" max="250" placeholder="{% trans 'leer = Profil-Wert wird verwendet' %}">
        <small class="text-muted">{% trans "Leer lassen = Größe aus Profil verwenden" %}</small>
    </div>

    <div class="card bg-dark border-secondary mb-3">
        <div class="card-body text-center py-3">
            <label class="form-label text-secondary text-uppercase fw-bold ls-1">{% trans "Gewicht (kg)" %}</label>
            <div class="input-group justify-content-center">
                <input type="number" step="0.1" name="gewicht" value="{{ wert.gewicht }}" class="form-control form-control-lg bg-dark text-white text-center border-0 display-1 fw-bold" style="font-size: 3rem; max-width: 200px;" required autofocus>
            </div>
        </div>
    </div>

    <h6 class="text-secondary mb-3 ps-2 mt-4">{% trans "Daten von der Uhr" %}</h6>

    <div class="card bg-dark border-secondary mb-3">
        <div class="card-body pb-2 pt-3">
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-droplet-fill text-danger me-2"></i>
                <span class="text-muted small fw-bold">{% trans "FETTMASSE" %}</span>
                <span class="ms-auto text-muted" style="font-size:0.7rem">{% trans "eines eingeben → anderes wird berechnet" %}</span>
            </div>
            <div class="row g-2">
                <div class="col-6">
                    <label class="text-muted" style="font-size:0.72rem">kg</label>
                    <input id="fett_kg" type="number" step="0.1" name="fettmasse_kg"
                           value="{{ wert.fettmasse_kg|default:'' }}"
                           class="form-control bg-transparent text-white border-secondary fw-bold fs-5 text-center"
                           placeholder="–">
                </div>
                <div class="col-6">
                    <label class="text-muted" style="font-size:0.72rem">%</label>
                    <input id="kfa" type="number" step="0.1" name="koerperfett_prozent"
                           value="{{ wert.koerperfett_prozent|default:'' }}"
                           class="form-control bg-transparent text-white border-secondary fw-bold fs-5 text-center"
                           placeholder="–">
                </div>
            </div>
        </div>
    </div>

    <div class="card bg-dark border-secondary mb-3">
        <div class="card-body pb-2 pt-3">
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-lightning-fill text-warning me-2"></i>
                <span class="text-muted small fw-bold">{% trans "MUSKELMASSE" %}</span>
                <span class="ms-auto text-muted" style="font-size:0.7rem">{% trans "eines eingeben → anderes wird berechnet" %}</span>
            </div>
            <div class="row g-2">
                <div class="col-6">
                    <label class="text-muted" style="font-size:0.72rem">kg</label>
                    <input id="muskel_kg" type="number" step="0.1" name="muskelmasse_kg"
                           value="{{ wert.muskelmasse_kg|default:'' }}"
                           class="form-control bg-transparent text-white border-secondary fw-bold fs-5 text-center"
                           placeholder="–">
                </div>
                <div class="col-6">
                    <label class="text-muted" style="font-size:0.72rem">%</label>
                    <input id="muskel_prozent" type="number" step="0.1" name="muskelmasse_prozent"
                           value="{{ wert.muskelmasse_prozent|default:'' }}"
                           class="form-control bg-transparent text-white border-secondary fw-bold fs-5 text-center"
                           placeholder="–">
                </div>
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 mt-5 pb-5">
        <button type="submit" class="btn btn-primary btn-lg fw-bold p-3 rounded-4">
            <i class="bi bi-check-lg me-2"></i>{% trans "Änderungen speichern" %}
        </button>
        <a href="{% url 'body_stats' %}" class="btn btn-secondary">{% trans "Abbrechen" %}</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function () {
    const gewichtInput = document.querySelector('input[name="gewicht"]');
    function getGewicht() { return parseFloat(gewichtInput?.value) || null; }
    function round1(val) { return Math.round(val * 10) / 10; }

    const fettKg  = document.getElementById('fett_kg');
    const fettPct = document.getElementById('kfa');
    const muskelKg  = document.getElementById('muskel_kg');
    const muskelPct = document.getElementById('muskel_prozent');

    fettKg.addEventListener('input', function () {
        const g = getGewicht();
        if (g && this.value) fettPct.value = round1(parseFloat(this.value) / g * 100);
        else if (!this.value) fettPct.value = '';
    });
    fettPct.addEventListener('input', function () {
        const g = getGewicht();
        if (g && this.value) fettKg.value = round1(parseFloat(this.value) / 100 * g);
        else if (!this.value) fettKg.value = '';
    });
    muskelKg.addEventListener('input', function () {
        const g = getGewicht();
        if (g && this.value) muskelPct.value = round1(parseFloat(this.value) / g * 100);
        else if (!this.value) muskelPct.value = '';
    });
    muskelPct.addEventListener('input', function () {
        const g = getGewicht();
        if (g && this.value) muskelKg.value = round1(parseFloat(this.value) / 100 * g);
        else if (!this.value) muskelKg.value = '';
    });
    gewichtInput?.addEventListener('input', function () {
        const g = parseFloat(this.value) || null;
        if (!g) return;
        if (fettKg.value)    fettPct.value    = round1(parseFloat(fettKg.value)    / g * 100);
        if (fettPct.value)   fettKg.value     = round1(parseFloat(fettPct.value)   / 100 * g);
        if (muskelKg.value)  muskelPct.value  = round1(parseFloat(muskelKg.value)  / g * 100);
        if (muskelPct.value) muskelKg.value   = round1(parseFloat(muskelPct.value) / 100 * g);
    });
})();
</script>
{% endblock %}
