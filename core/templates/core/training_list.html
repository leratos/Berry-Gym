{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Trainings-Logbuch" %}{% endblock %}

{% block page_nav %}
<nav class="navbar navbar-page border-bottom">
  <div class="container-fluid">
    <a class="btn btn-outline-secondary border-0" href="{% url 'dashboard' %}">
        <i class="bi bi-arrow-left"></i> {% trans "Dashboard" %}
    </a>
    <span class="navbar-text page-title fw-bold">{% trans "Dein Verlauf" %}</span>
    <div style="width: 40px;">
        <button onclick="toggleTheme()" class="btn btn-sm btn-outline-secondary border-0 ms-2" title="Theme wechseln">
            <i class="bi bi-moon-fill" id="themeIcon"></i>
        </button>
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="container pt-3">

  {% if not trainings_data %}
    <div class="text-center py-5 text-muted">
        <i class="bi bi-journal-x display-1 opacity-25"></i>
        <p class="mt-3">{% trans "Noch keine Trainings absolviert." %}</p>
        <a href="{% url 'training_select_plan' %}" class="btn btn-primary mt-2">{% trans "Jetzt starten!" %}</a>
    </div>
  {% else %}

    <div class="list-group">
        {% for data in trainings_data %}
        <div class="list-group-item card-stat border-secondary mb-2 rounded-3 p-0 overflow-hidden">
            <div class="d-flex w-100 align-items-stretch">

                <!-- Großer Klickbereich für Details -->
                <a href="{% url 'training_session' data.training.id %}" class="text-decoration-none d-flex flex-grow-1 p-3 align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="mb-1 text-primary fw-bold">
                            {{ data.training.datum|date:"d.m.Y" }}
                        </h5>
                        <small class="text-muted">
                            <i class="bi bi-clock"></i> {{ data.training.datum|date:"H:i" }} Uhr
                            {% if data.training.dauer_minuten %}
                            &bull; {{ data.training.dauer_minuten }} Min
                            {% endif %}
                        </small>
                        <div class="mt-2">
                            <span class="badge bg-secondary me-1">
                                <i class="bi bi-layers-half"></i> {{ data.arbeitssaetze }} {% trans "Sätze" %}
                            </span>
                            <span class="badge bg-success">
                                <i class="bi bi-bar-chart-fill"></i> {{ data.volumen|floatformat:0 }} kg
                            </span>
                        </div>
                        {% if data.training.kommentar %}
                        <div class="mt-2 text-muted small fst-italic">
                            <i class="bi bi-chat-left-text me-1"></i>{{ data.training.kommentar|truncatechars:80 }}
                        </div>
                        {% endif %}
                    </div>
                </a>

                <!-- Löschen Button (Rechts) -->
                <div class="border-start border-secondary d-flex">
                    <button class="btn btn-link text-danger text-decoration-none d-flex align-items-center px-3"
                            onclick="confirmDeleteTraining('{{ data.training.id }}', '{{ data.training.datum|date:"d.m.Y" }}', '{{ data.arbeitssaetze }}', '{{ data.volumen|floatformat:0 }}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>

            </div>
        </div>
        {% endfor %}
    </div>

  {% endif %}

</div>

<!-- DELETE TRAINING MODAL -->
<div class="modal fade" id="deleteTrainingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-danger">
      <div class="modal-header border-danger">
        <h5 class="modal-title text-danger">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>{% trans "Training löschen?" %}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">{% trans "Möchtest du dieses Training wirklich unwiderruflich löschen?" %}</p>
        <div class="alert alert-secondary mb-0">
            <strong id="deleteTrainingDate"></strong><br>
            <small class="text-muted">
                <i class="bi bi-layers-half"></i> <span id="deleteTrainingSets"></span> {% trans "Sätze" %} &bull;
                <i class="bi bi-bar-chart-fill"></i> <span id="deleteTrainingVolume"></span> kg
            </small>
        </div>
        <p class="text-warning small mt-3 mb-0">
            <i class="bi bi-info-circle"></i> {% trans "Alle Sätze gehen verloren!" %}
        </p>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">{% trans "Abbrechen" %}</button>
        <!-- POST-Form statt GET-Link: Verhindert versehentliches Löschen durch Prefetching -->
        <form id="deleteTrainingForm" method="post" action="" class="d-inline m-0">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">
                <i class="bi bi-trash-fill me-1"></i> {% trans "Ja, unwiderruflich löschen" %}
            </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const deleteTrainingModalEl = document.getElementById('deleteTrainingModal');
    const deleteTrainingModal = new bootstrap.Modal(deleteTrainingModalEl);

    function confirmDeleteTraining(trainingId, datum, saetze, volumen) {
        document.getElementById('deleteTrainingDate').innerText = datum;
        document.getElementById('deleteTrainingSets').innerText = saetze;
        document.getElementById('deleteTrainingVolume').innerText = volumen;
        // POST-Form: action auf die Delete-URL setzen
        document.getElementById('deleteTrainingForm').action = `/training/${trainingId}/delete/`;
        deleteTrainingModal.show();
    }
</script>
{% endblock %}
